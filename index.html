<!-- code for video credit: http://jsfiddle.net/dsbonev/cCCZ2/-->

<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
		<link rel="stylesheet" href="bootstrap.css">
		<script src="bootstrap.js"></script>
 		<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>
		<style type="text/css">
			video, input {
			    display: block;
			}

			input {
			    width: 100%;       
			}

			.info {
			    background-color: aqua;            
			}

			.error {
			    background-color: red;
			    color: white;
			}
		</style>
	</head>

	<body>
		<h1>Watch mp4, webm or ogg videos together with the use of WebRTC</h1>
		<div id="message"></div> 
		<div id="my_id"></div>
		<div>
			<div id="connect_div">
	            <input type="text" placeholder="Connect user id..." id="connect_id">
	            <a href="#" class="btn btn-success" id="connect">connect</a>
        	</div>
        	<div id="disconnect_div">
        		<a href="#" class="btn btn-danger" id="disconnect">disconnect</a>
        		<a href="#" class="btn btn-success" id="voice_call">voice</a>
        		<a href="#" class="btn btn-warning" id="end_voice_call">end voice</a>
        	</div>
         </div>
        <div id="video_div">
			<input type="file" accept="video/mp4,video/webm,video/ogg,audio/*" id="video_file"/>
			<video controls ></video>
		</div>
		<div id="voice">
			<audio controls autoplay></audio>
		</div>
	</body>
</html>

<script type="text/javascript">
		var videoNode;
		var conn;
		var last_received_time;
		var call;
		$("#voice").hide();
		$("#disconnect_div").hide();
		$("#end_voice_call").hide();
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
		navigator.getUserMedia({audio: true, video: false}, function(stream){
	        // Set your video displays
	        //$('#my-video').prop('src', URL.createObjectURL(stream));
	        window.localStream = stream;
	      },function(){});
		 var words = ["the","name","very","through","and","just","form","much","great","think","you","say","that","help","low","was","line","for","before","turn","are","cause","with","same","mean","differ","his","move","they","right","boy","old","one","too","have","does","this","tell","from","sentence","set","had","three","want","hot","air","but","well","some","also","what","play","there","small","end","can","put","out","home","other","read","were","hand","all","port","your","large","when","spell","add","use","even","word","land","how","here","said","must","big","each","high","she","such","which","follow","act","their","why","time","ask","men","will","change","way","went","about","light","many","kind","then","off","them","need","would","house","write","picture","like","try","these","again","her","animal","long","point","make","mother","thing","world","see","near","him","build","two","self","has","earth","look","father","more","head","day","stand","could","own","page","come","should","did","country","found","sound","answer","school","most","grow","number","study","who","still","over","learn","know","plant","water","cover","than","food","call","sun","first","four","people","thought","may","let","down","keep","side","eye","been","never","now","last","find","door","any","between","new","city","work","tree","part","cross","take","since","get","hard","place","start","made","might","live","story","where","saw","after","far","back","sea","little","draw","only","left","round","late","man","run","year","came","while","show","press","every","close","good","night","real","give","life","our","few","under","stop","open","ten","seem","simple","together","several","next","vowel","white","toward","children","war","begin","lay","got","against","walk","pattern","example","slow","ease","center","paper","love","often","person","always","money","music","serve","those","appear","both","road","mark","map","book","science","letter","rule","until","govern","mile","pull","river","cold","car","notice","feet","voice","care","fall","second","power","group","town","carry","fine","took","certain","rain","fly","eat","unit","room","lead","friend","cry","began","dark","idea","machine","fish","note","mountain","wait","north","plan","once","figure","base","star","hear","box","horse","noun","cut","field","sure","rest","watch","correct","color","able","face","pound","wood","done","main","beauty","enough","drive","plain","stood","girl","contain","usual","front","young","teach","ready","week","above","final","ever","gave","red","green","list","though","quick","feel","develop","talk","sleep","bird","warm","soon","free","body","minute","dog","strong","family","special","direct","mind","pose","behind","leave","clear","song","tail","measure","produce","state","fact","product","street","black","inch","short","lot","numeral","nothing","class","course","wind","stay","question","wheel","happen","full","complete","force","ship","blue","area","object","half","decide","rock","surface","order","deep","fire","moon","south","island","problem","foot","piece","yet","told","busy","knew","test","pass","record","farm","boat","top","common","whole","gold","king","possible","size","plane","heard","age","best","dry","hour","wonder","better","laugh","true.","thousand","during","ago","hundred","ran","check","remember","game","step","shape","early","yes","hold","hot","west","miss","ground","brought","interest","heat","reach","snow","fast","bed","five","bring","sing","sit","listen","perhaps","six","fill","table","east","travel","weight","less","language","morning","among"];
	    //alert(words[Math.floor(Math.random()*words.length)]);
	    var random_id = words[Math.floor(Math.random()*words.length)]+"-"+words[Math.floor(Math.random()*words.length)]+"-"+Math.floor(Math.random()*100+10);
    	var peer = new Peer(random_id,{ key: 'yqyt65uodybbuik9', debug: 3, config: {'iceServers': [
	      { url: 'stun:stun.l.google.com:19302' } // Pass in optional STUN and TURN server for maximum network compatibility
	    ]}});
	    peer.on('open', function(){
	    	console.log(peer.id);
	    	$("#my_id").text("Your ID is: "+ peer.id);
	    });
	    peer.on('connection',function(conn){	
	    	console.log(conn.peer);
	    	$("#connect_id").val(conn.peer);
	    	my_connect(conn);
	    	
	    });
	    peer.on('call', function(call_in){
	    	call = call_in;
	      // Answer the call automatically (instead of prompting user) for demo purposes
	      console.log("Received call");
	      call.answer(window.localStream);
	      call.on('stream', function(stream){
	        $('audio').prop('src', URL.createObjectURL(stream));
	        $("#end_voice_call").show();
		    $("#voice_call").hide();
	  	  });
	  	  call.on('close', function(){
	  	  	$("#end_voice_call").hide();
		        $("#voice_call").show();
	  	  });
	      //step3(call);
	    });
	    
	    function my_connect(connection){
	    	conn = connection;
	    	conn.on('open',function(){
	    		console.log("Connected");
	    		$("#connect_div").hide();
	    		$("#disconnect_div").show();
	    		
		    	conn.on('data', function(data){
		    		var message_json = jQuery.parseJSON(data);
		    		if(message_json.action_change == "paused" && !videoNode.paused){
		    			videoNode.currentTime = message_json.time_of_movie;
		    			videoNode.pause();
		    		}
		    		if(message_json.action_change == "play" && videoNode.paused){
		    			//videoNode.currentTime = message_json.time_of_movie;
		    			videoNode.play();
		    		}
		    		if(message_json.action_change == "seek"){
		    			if(last_received_time != message_json.time_of_movie){
		    				last_received_time = message_json.time_of_movie;
		    				videoNode.currentTime = message_json.time_of_movie;
		    			}
		    			//videoNode.play();
		    		}
		    		console.log('Received ' + data);
	    		});
	    		
	   		});
	   		conn.on('close', function(){
	   			console.log("Disconnected");
	   			$("#connect_div").show();
	    		$("#disconnect_div").hide();
	   		});
	    }
	    $("#connect").click(function(){
	    	console.log($("#connect_id").val());
	    	conn = peer.connect($("#connect_id").val());
	    	my_connect(conn);
	    });
	    $("#disconnect").click(function(){
	    	//console.log($("#connect_id").val());
	    	conn.close();

	    	//my_connect(conn);
	    });
	    $("#voice_call").click(function(){
	    	call = peer.call($('#connect_id').val(), window.localStream);
	    	call.on('stream', function(stream){
		        $('audio').prop('src', URL.createObjectURL(stream));
		        $("#end_voice_call").show();
		        $("#voice_call").hide();
		    });
		    call.on('close', function(){
	  	  	$("#end_voice_call").hide();
		        $("#voice_call").show();
	  	 	 });
	    });
	    $("#end_voice_call").click(function(){
	    	call.close();
	    });
		(function localFileVideoPlayerInit(win) {
	    var URL = win.URL || win.webkitURL,
	        displayMessage = (function displayMessageInit() {
	            var node = document.querySelector('#message');

	            return function displayMessage(message, isError) {
	                node.innerHTML = message;
	                node.className = isError ? 'error' : 'info';
	            };
	        }()),
	        playSelectedFile = function playSelectedFileInit(event) {
	            var file = this.files[0];

	            var type = file.type;

	            videoNode = document.querySelector('video');

	            var canPlay = videoNode.canPlayType(type);

	            canPlay = (canPlay === '' ? 'no' : canPlay);

	            var message = 'Can play type "' + type + '": ' + canPlay;

	            var isError = canPlay === 'no';

	            displayMessage(message, isError);

	            if (isError) {
	                return;
	            }

	            var fileURL = URL.createObjectURL(file);

	            videoNode.src = fileURL;
	            console.log(videoNode.readyState);
				videoNode.onpause = function() {
					
				   	console.log("Paused " + videoNode.currentTime);
	            	conn.send('{"action_change":"paused", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');

				};
				videoNode.onseeked = function() {
				    console.log("Seeked " + videoNode.currentTime);
				    conn.send('{"action_change":"seek", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
				};
				videoNode.onplaying = function() {
				    console.log("Playing " + videoNode.currentTime);
				    //conn.send('{"action":"status", "time":"'+videoNode.currentTime+'"}');
				    conn.send('{"action_change":"play", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
				};
	        },
	        inputNode = document.querySelector('#video_file');
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
	    inputNode.addEventListener('change', playSelectedFile, false);
	}(window));
</script>