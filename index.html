<!-- code for video credit: http://jsfiddle.net/dsbonev/cCCZ2/-->

<!DOCTYPE html>
<html>
	<head>
		<title>Watch videos together</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<link rel="stylesheet" href="bootstrap.css">
		<link href="css/styles.css" rel="stylesheet">
		<script type="text/javascript" src="js/jquery-impromptu.js"></script>
		<link rel="stylesheet" href="css/jquery-impromptu.css">
		<script src="bootstrap.js"></script>
		<script src="js/scripts.js"></script>
 		<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>
		<style type="text/css">
			video, input {
			    display: block;
			}

			input {
			    width: 100%;       
			}

			.info {
			    background-color: aqua;            
			}

			.error {
			    background-color: red;
			    color: white;
			}
			
		</style>
	</head>

	<body background="img/background.png">
		<nav class="navbar navbar-trans navbar-fixed-top" role="navigation">
		  <div class="container">
		    <!-- Brand and toggle get grouped for better mobile display -->
		    <div class="navbar-header">
		      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
		        <span class="sr-only">Toggle navigation</span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		      </button>
		      <a class="navbar-brand" href="#section1">simulchat.com</a>
		    </div>

		    <!-- Collect the nav links, forms, and other content for toggling -->
		    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
		      <ul class="nav navbar-nav">
		        <li ><a href="#section2">Connection<span class="sr-only">(current)</span></a></li>
		        <li ><a href="#section3">Watch Video<span class="sr-only">(current)</span></a></li>
		        <li ><a href="#section4">Watch YouTube<span class="sr-only">(current)</span></a></li>
		        <li ><a href="#section5">IRC Chat<span class="sr-only">(current)</span></a></li>

		       

		      </ul>
		    </div><!-- /.navbar-collapse -->
		  </div><!-- /.container-fluid -->
		</nav>
		<section class="container-fluid" id="section1">
		<div class="container">
			<div style="text-align:center;">			
				<h1 id="page_title">Welcome to SimulChat</h1>
			</div>	
			<div class="row" style="text-align:center;">
				<div class="col-md-3"></div>
				<div class="col-md-6">
					<h4>Watch movies together</h4>
					<h4>Watch YouTube together</h4>
					<h4>Talk to each other</h4>
				</div>
				<div class="col-md-3"></div>

			</div>
		</div>

		<div style="text-align:center;">
			<button class="btn btn-success btn-lg" id="take_tour">Take Tour</button>
		</div>
		</section>
		<section class="container-fluid" id="section2">
		<div style="text-align:center;">			
			<h1>Connect to Partner</h1>
		</div>	
		<br><br>
		<div class="container-fluid" id="connection_div">
			<div class="row">
				<div class="col-md-4"></div>
				<div class="col-md-4">
					<div class="form-horizontal">
						<!-- <div id="message">Your ID is: <input type="text" id="my_id" size="15"></div>  -->
						<div class="form-group">
						    <label for="my_id" class="col-md-4 control-label">Your ID is: </label>
						    <div class="col-md-8">
						   		<input type="text" class="form-control" id="my_id">
						   	</div>
					 	</div>
					 	<div class="form-group">
						    <label for="my_id" class="col-md-4 control-label">Partner ID: </label>
						    <div class="col-md-8">
							    <input type="text" class="form-control" id="connect_id">
							    <a href="#" class="btn btn-success" id="connect">connect</a>
							    <span id="disconnect_div">
				        		<!-- <div>
				        			You are connected to: <span id="connected_id"></span>
				        		</div> -->
				        		<a href="#" class="btn btn-danger" id="disconnect">disconnect</a>
				        		<a href="#" class="btn btn-success" id="voice_call">voice call</a>
				        		<a href="#" class="btn btn-info" id="hang_up">cancel call</a>
				        		<a href="#" class="btn btn-warning" id="end_voice_call">end voice</a>
				        		</span>
						    </div>
					 	</div>
							
						
					</div>
				</div>
				<div class="col-md-4"></div>
			</div>
			
		</div>	
		<div class="container-fluid">
			
				<!-- <div id="connect_div" class="col-md-3">
		            <input type="text" placeholder="Connect user id..." id="connect_id">
		            <a href="#" class="btn btn-success" id="connect">connect</a>
	        	</div> -->
	        	<div class="row" style="text-align:center;">

		        	
	        	</div>

         </div>
         </section>
         <section class="container-fluid" id="section3">
         <div style="text-align:center;">			
			<h1>Watch Videos Together</h1>
		</div>	
		<br><br>
        <div class="container">
        	<div class="col-md-3">
        		<table class="table table-bordered" id="my_status_table">
        			<thead>
        				<th colspan="100%" style="text-align:center;">My Status</th>
        			</thead>
        			<tbody style="text-align:center;">
        				<tr>
        					<td>ID</td>
        					<td id="stat_my_id"></td>
        				</tr>
        				<tr>
        					<td>Microphone</td>
        					<td id="stat_my_mic">Inactive</td>
        				</tr>
        				<tr>
        					<td>Title</td>
        					<td id="stat_my_video"></td>
        				</tr>
        				<tr>
        					<td>Size</td>
        					<td id="stat_my_size"></td>
        				</tr>
        			</tbody>
        		</table>
        	</div>
	        <div id="video_div" class="col-md-6">
				<input type="file" accept="video/mp4,video/webm,video/ogg,audio/*" id="video_file"/>
				<video id="my_video" width="720" height="480" controls >
				</video>
			</div>	
        	<div class="col-md-3">
        		<table class="table table-bordered" id="partner_status_table" style="word-wrap:break-word;">
        			<thead>
        				<th colspan="100%" style="text-align:center;">Partner Status</th>
        			</thead>
        			<tbody style="text-align:center;">
        				<tr>
        					<td>ID</td>
        					<td id="stat_partner_id"></td>
        				</tr>
        				<tr>
        					<td>Microphone</td>
        					<td id="stat_partner_mic"></td>
        				</tr>
        				<tr>
        					<td>Title</td>
        					<td id="stat_partner_video"></td>
        				</tr>
        				<tr>
        					<td>Size</td>
        					<td id="stat_partner_size"></td>
        				</tr>
        			</tbody>
        		</table>
        	</div>

		</div>
		</section>
		<section class="container-fluid" id="section4">
		<div style="text-align:center;">			
			<h1>Watch YouTube Together</h1>
		</div>	
		<div class="container" style="text-align:center;">
	      <div class="row">
	        <div class="col-md-2"></div>
	        <div id="the_player" class="col-md-8">
	          <div id="player"></div>
	          <div>
	           
	          </div>
	        </div>
	        <div class="col-md-2">
	        		<div>
	        		Please note that the YouTube sync function is still in progress. Feel free to use it, but expect some issues.
	        	</div>
	        </div>

	      </div>
	    </div>
	    <div class="container" style="text-align:center;">
	      <div class="row">
	        <div class="col-md-3"></div>
	          <div id="load_new_vid" class="col-md-6">
	              <input type="text" placeholder="enter youtube link" id="youtube_link"  >
	              
	          </div>
	      
	        <div class="col-md-3">
	        </div>
	      </div>  

	        <div class="row">
	          <div class="col-md-2"></div>
	          <div class="col-md-8">
	              <a href="#" class="btn btn-success" id="load_vid">load</a>
	          </div>
	          
	          <div class="col-md-2"></div>
	        </div>
	    </div>
		<div id="voice">
			<audio controls autoplay></audio>
		</div>
		</section>

		<section class="container-fluid" id="section5">
		<div style="text-align:center;">			
			<h1>Find Partner exchange ID's</h1>
		</div>	
		<br>
		<div id="irc_chat" class="container">
			<div class="row">
				<div class="col-md-2"></div>
				<div class="col-md-8">
					<iframe src="https://kiwiirc.com/client/irc.kiwiirc.com/?&theme=basic##simulchat" style="border:0; width:100%; height:450px;" id="kiwi_irc_frame"></iframe>
				</div>
				<div class="col-md-2"></div>
			</div>
		</div>
		<br><br>
		</section>
	</body>
</html>

<script type="text/javascript">

		if(!((navigator.userAgent.indexOf("Chrome") != -1) || (navigator.userAgent.indexOf("Firefox") != -1) || (navigator.userAgent.indexOf("Opera") != -1)))
		{
			alert("This website will only work in Chrome, Firefox and Opera");
			//$('html').empty();
		}
		var videoNode;
		var conn;
		var last_received_time = 0;
		var call;
		
		//youtube variables
			var player;
     		var time; 
     		var partner_is_buffering = false;
     		var partner_previous_state = -2;
     		var restart_after_buffer;
     		var previous_state;
		//end of youtube variables

		var stat_my_id = "-";
		var stat_my_mic = "-";
		var stat_my_video = "-";
		var stat_my_size = "-";
		var stat_partner_id = "-";
		var stat_partner_mic = "-";
		var stat_partner_video = "-";
		var stat_partner_size = "-";
		updateMyStatus();
		updatePartnerStatus();
		$("#voice").hide();
		$("#disconnect_div").hide();
		$("#end_voice_call").hide();
		$("#hang_up").hide();
		var video_width = $("#video_div").width();
		var video_height = Math.round(video_width * 9 / 16);
		//var previous_partner_seektime = 0;
		$("#my_video").width(video_width);
		$("#my_video").height(video_height);
		var file;
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
		function get_mic(){
			
			navigator.getUserMedia({audio: true, video: false}, function(stream){
	        // Set your video displays
	        //$('#my-video').prop('src', URL.createObjectURL(stream));
	        window.localStream = stream;
	        //$("#stat_my_mic").text("Active");
	        stat_my_mic = "active";
	        sendStatus();
	        updateMyStatus();
	      },function(){
	      	console.log("Microphone not granted");
	      });
		}
		get_mic();
		 var words = ["the","name","very","through","and","just","form","much","great","think","you","say","that","help","low","was","line","for","before","turn","are","cause","with","same","mean","differ","his","move","they","right","boy","old","one","too","have","does","this","tell","from","sentence","set","had","three","want","hot","air","but","well","some","also","what","play","there","small","end","can","put","out","home","other","read","were","hand","all","port","your","large","when","spell","add","use","even","word","land","how","here","said","must","big","each","high","she","such","which","follow","act","their","why","time","ask","men","will","change","way","went","about","light","many","kind","then","off","them","need","would","house","write","picture","like","try","these","again","her","animal","long","point","make","mother","thing","world","see","near","him","build","two","self","has","earth","look","father","more","head","day","stand","could","own","page","come","should","did","country","found","sound","answer","school","most","grow","number","study","who","still","over","learn","know","plant","water","cover","than","food","call","sun","first","four","people","thought","may","let","down","keep","side","eye","been","never","now","last","find","door","any","between","new","city","work","tree","part","cross","take","since","get","hard","place","start","made","might","live","story","where","saw","after","far","back","sea","little","draw","only","left","round","late","man","run","year","came","while","show","press","every","close","good","night","real","give","life","our","few","under","stop","open","ten","seem","simple","together","several","next","vowel","white","toward","children","war","begin","lay","got","against","walk","pattern","example","slow","ease","center","paper","love","often","person","always","money","music","serve","those","appear","both","road","mark","map","book","science","letter","rule","until","govern","mile","pull","river","cold","car","notice","feet","voice","care","fall","second","power","group","town","carry","fine","took","certain","rain","fly","eat","unit","room","lead","friend","cry","began","dark","idea","machine","fish","note","mountain","wait","north","plan","once","figure","base","star","hear","box","horse","noun","cut","field","sure","rest","watch","correct","color","able","face","pound","wood","done","main","beauty","enough","drive","plain","stood","girl","contain","usual","front","young","teach","ready","week","above","final","ever","gave","red","green","list","though","quick","feel","develop","talk","sleep","bird","warm","soon","free","body","minute","dog","strong","family","special","direct","mind","pose","behind","leave","clear","song","tail","measure","produce","state","fact","product","street","black","inch","short","lot","numeral","nothing","class","course","wind","stay","question","wheel","happen","full","complete","force","ship","blue","area","object","half","decide","rock","surface","order","deep","fire","moon","south","island","problem","foot","piece","yet","told","busy","knew","test","pass","record","farm","boat","top","common","whole","gold","king","possible","size","plane","heard","age","best","dry","hour","wonder","better","laugh","true.","thousand","during","ago","hundred","ran","check","remember","game","step","shape","early","yes","hold","hot","west","miss","ground","brought","interest","heat","reach","snow","fast","bed","five","bring","sing","sit","listen","perhaps","six","fill","table","east","travel","weight","less","language","morning","among"];
	    //alert(words[Math.floor(Math.random()*words.length)]);
	    var random_id = words[Math.floor(Math.random()*words.length)]+"-"+words[Math.floor(Math.random()*words.length)]+"-"+Math.floor(Math.random()*100+10);
    	var peer = new Peer(random_id,{ key: 'yqyt65uodybbuik9', debug: 3, config: {'iceServers': [
	      { url: 'stun:stun.l.google.com:19302' },
				{
					url: 'turn:numb.viagenie.ca',
					credential: 'muazkh',
					username: 'webrtc@live.com'
				},
				{
					url: 'turn:192.158.29.39:3478?transport=udp',
					credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					username: '28224511:1379330808'
				},
				{
					url: 'turn:192.158.29.39:3478?transport=tcp',
					credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					username: '28224511:1379330808'
				} // Pass in optional STUN and TURN server for maximum network compatibility
	    ]}});
	    peer.on('open', function(){
	    	console.log(peer.id);
	    	$("#my_id").val(peer.id);
	    	stat_my_id = peer.id;
	    	updateMyStatus();
	    	//$("#stat_my_id").text(peer.id);
	    });
	    peer.on('connection',function(conn){	
	    	console.log(conn.peer);
	    	//var the_peer = conn.peer;
	    	$("#connect_id").val(conn.peer);
	    	//$("#connected_id").text("hello");
	    	//alert(conn.peer);
	    	my_connect(conn);
	    	
	    });
	    peer.on('call', function(call_in){
	      call = call_in;
	      console.log("Received call");
	      if(window.localStream == null){
	      	get_mic();
	      	conn.send('{"call_status": "mic_inactive"}');
	      	$.prompt("There is an incoming voice call from your partner, but your microphone is not activated. Please activate your microphone.", {
			title: "Activate your microphone",
			buttons: { "OK": true}
			//timeout: 20000,
			});

	      }
	      else{
	      // Answer the call automatically (instead of prompting user) for demo purposes
	      
	      $.prompt("There is an incoming voice call from your partner.", {
			title: "Incoming call",
			buttons: { "Answer": true, "Not now": false },
			//timeout: 20000,
			submit: function(e,v,m,f){
				// use e.preventDefault() to prevent closing when needed or return false. 
				// e.preventDefault(); 
				if(v == true){
				  call.answer(window.localStream);
			      call.on('stream', function(stream){
			        $('audio').prop('src', URL.createObjectURL(stream));
			        $("#end_voice_call").show();
				    $("#voice_call").hide();
			  	  });
			  	  call.on('close', function(){
			  	  	$("#end_voice_call").hide();
				    $("#voice_call").show();
			  	  });
				}
				else{
					conn.send('{"call_status": "hang_up"}');
				}
				console.log("Value clicked was: "+ v);
			}
			});
	 	 }
	      
	      //step3(call);
	    });
	    function insert_space(str,pos){
	    	var str_length = str.length;
	    	return str.substring(0,pos) + " " + str.substring(pos, str_length);
	    }
	    function insert_spaces(str, chars){
	    	var str_length = str.length;
	    	var number_of_spaces = Math.floor((str_length-1)/chars);
	    	var return_string = "";
	    	for(var i = 0; i <number_of_spaces+1; i++){
	    		return_string = return_string + str.substring(i*chars,(i+1)*chars) + " ";
	    	}
	    	return return_string;
	    }
	    function my_connect(connection){
	    	conn = connection;
	    	$("#connected_id").text(conn.peer);
	    	stat_partner_id = conn.peer;
	    	updatePartnerStatus();
	    	conn.on('open',function(){
	    		console.log("Connected");
	    		$("#connect").hide();
	    		$("#disconnect_div").show();
	    		
		    	conn.on('data', function(data){
		    		var message_json = jQuery.parseJSON(data);
		    		if(message_json.call_status == "hang_up"){
		    			call.close();
		    			$("#hang_up").hide();
		    			$("#voice_call").show();
		    		}
		    		if(message_json.call_status == "mic_inactive"){
		    			call.close();
		    			$("#hang_up").hide();
		    			$("#voice_call").show();
		    			$.prompt("Your partner's microphone is not activated. Please try again.", {
							title: "Partner microphone inactive",
							buttons: { "OK": true}
						});
		    		}
		    		if(message_json.action_change == "paused" && !videoNode.paused){
		    			videoNode.currentTime = message_json.time_of_movie;
		    			videoNode.pause();
		    		}
		    		if(message_json.action_change == "play" && videoNode.paused){
		    			//videoNode.currentTime = message_json.time_of_movie;
		    			if(Math.abs(videoNode.currentTime - message_json.time_of_movie) > 1){
		    					videoNode.currentTime = message_json.time_of_movie;
		    			}
		    			videoNode.play();
		    		}
		    		if(message_json.action_change == "seek"){
		    			if(last_received_time != message_json.time_of_movie){
		    				last_received_time = message_json.time_of_movie;
		    				if(Math.abs(videoNode.currentTime - message_json.time_of_movie) > 1){
		    					videoNode.currentTime = message_json.time_of_movie;
		    				}
		    			}
		    			//videoNode.play();
		    		}
		    		if(message_json.stat_mic != null)
		    		{
		    			stat_partner_mic = message_json.stat_mic;
		    		}
		    		if(message_json.stat_video != null)
		    		{
		    			stat_partner_video = message_json.stat_video;

		    		}
		    		if(message_json.stat_size != null)
		    		{
		    			stat_partner_size = message_json.stat_size;
		    		}
		    		if(message_json.user_action =='youtube')
		    		{
		    			var user_event = message_json.user_event;
		    			if(user_event == YT.PlayerState.PAUSED){
		    				if(player.getPlayerState() != YT.PlayerState.PAUSED )
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					player.pauseVideo();
		    				}
		    			}
		    			if(user_event == YT.PlayerState.BUFFERING){
		    				partner_is_buffering = true;
		    				if(player.getPlayerState() != YT.PlayerState.PAUSED)
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					player.pauseVideo();
		    				}
		    			}
		    			if(user_event == YT.PlayerState.PLAYING){
		    				partner_is_buffering = false;
		    				if(player.getPlayerState() != YT.PlayerState.PLAYING)
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					player.playVideo();
		    				}
		    			}	
		    			if(user_event == 'seeked'){
		    				
		    				if(Math.abs(player.getCurrentTime() - message_json.youtube_time) > 1)
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					time = message_json.youtube_time;

		    				}
		    			}
		    			if(user_event == 'new_video'){
		    				
		    				player.loadVideoById(message_json.new_vid_id);
				          	player.seekTo(0);
				          	player.pauseVideo();
		    			}	
		    			partner_previous_state = user_event;

		    		}
		    		updatePartnerStatus();
		    		console.log('Received ' + data);
	    		});
	    		
	   		});
	   		conn.on('close', function(){
	   			console.log("Disconnected");
	   			if(call){
	   				call.close();
	   			}
	   			$("#connect").show();
	    		$("#disconnect_div").hide();
	   		});
	    }
	    $("#connect").click(function(e){
	    	e.preventDefault();
	    	console.log($("#connect_id").val());
	    	conn = peer.connect($("#connect_id").val().trim());
	    	my_connect(conn);
	    });
	    $("#disconnect").click(function(e){
	    	e.preventDefault();
	    	//console.log($("#connect_id").val());
	    	conn.close();

	    	//my_connect(conn);
	    });
	    $("#voice_call").click(function(e){
	    	e.preventDefault();
	    	if(window.localStream != null)
	    	{

	    		$("#voice_call").hide();
	    		$("#hang_up").show();
		    	call = peer.call($('#connect_id').val(), window.localStream);
		    	call.on('stream', function(stream){
		    		$("#hang_up").hide();
			        $('audio').prop('src', URL.createObjectURL(stream));
			        $("#end_voice_call").show();
			        $("#voice_call").hide();
			    });
			    call.on('close', function(){
			  	  	$("#end_voice_call").hide();
				    $("#voice_call").show();
				    $("#hang_up").hide();
		  	 	});
			}
			else{
				get_mic();
				$.prompt("Your browser is asking you to activate your microphone. The popup should be somewhere on the top or bottom of your screen", {
					title: "Activate Your Microphone and try again.",
					buttons: { "OK": true}

				});

			}
	    });
	    $("#hang_up").click(function(e){
	    	e.preventDefault();
	    	$("#hang_up").hide();
	    	$("#voice_call").show();
	    });
	    $("#end_voice_call").click(function(e){
	    	e.preventDefault();
	    	call.close();
	    });
	    $("#take_tour").click(function(e){
	    	e.preventDefault();
	    	takeTour();
	    });

	    function updateMyStatus(){
	    	$("#stat_my_id").text(stat_my_id);
	    	$("#stat_my_mic").text(stat_my_mic);
	    	$("#stat_my_video").text(stat_my_video);
	    	$("#stat_my_size").text(stat_my_size);
	    }

	    function updatePartnerStatus(){
	    	$("#stat_partner_id").text(stat_partner_id);
	    	$("#stat_partner_mic").text(stat_partner_mic);
	    	$("#stat_partner_video").text(stat_partner_video);
	    	$("#stat_partner_size").text(stat_partner_size);
	    }

	    function sendStatus(){
	    	conn.send('{"stat_mic":"'+stat_my_mic+'","stat_video":"'+stat_my_video+'","stat_size":"'+stat_my_size+'"}');
	    }

	    function takeTour(){
	    	var tourSubmitFunc = function(e,v,m,f){
			if(v === -1){
				$.prompt.prevState();
				return false;
			}
			else if(v === 1){
				$.prompt.nextState();
				return false;
			}
			},
			tourStates = [
				{
					title: 'Welcome to Simulchat!',
					html: 'Simulchat allows you to watch movies with someone over the internet. Both people must have their own copy video to play, preferably the same video. The video is NOT streamed.',
					buttons: { Next: 1 },
					focus: 0,
					position: { container: '#page_title', x: 300, y: 30, width: 400, arrow: '' },
					submit: tourSubmitFunc
				},
				{
					title: 'Your ID',
					html: 'This is your ID for this session. Give it to your partner and they can connect to you!',
					buttons: { Next: 1 },
					focus: 0,
					position: { container: '#my_id', x: 200, y: -10, width: 400, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: 'Their ID',
					html: 'If you have your partner\'s ID, enter it here and click Connect',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#connect_id', x: 200, y: -10, width: 400, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: "Open a video",
					html: 'Click here to open a video file from your computer. Your partner must also open a video on their side. The video is NOT streamed.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#video_file', x: 30, y: 25, width: 400, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'My Status',
					html: 'This table gives you some information about your status',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#my_status_table', x: 200, y: 0, width: 200, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: 'Partner Status',
					html: 'This table gives you some information about your partner\'s status',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#partner_status_table', x: -200, y: 0, width: 200, arrow: 'rt' },
					submit: tourSubmitFunc
				},
				{
					title: 'IRC Chat [optional]',
					html: 'This is a web IRC client that connects to a channel called ##simulchat. Here you can find your partner if they are online and send them your ID. It is advised to send a private message, since anyone can see what you time in the defualt channel. Just pick a Nickname and click start. Note that you do not need to use this chat box. It is just there to help you exchange your ID\'s. You can also send your ID to your partner in any way you please, like email',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#kiwi_irc_frame', x: 200, y: 120, width: 400, arrow: 'tm' },
					submit: tourSubmitFunc
				},
				{
					title: 'Watch Together',
					html: 'If you are connected to your partner and you both have a movie file selected, you can watch the movie here together. If you pause, they pause. If you skip, they skip and vice versa. Only instructions are sent over the internet, not the movie itself, so it barely uses any bandwidth.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#my_video', x: 100, y: 120, width: 600, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Voice Call',
					html: 'When you are connected to your partner, you can enable a voice call so that you can speak while watching the movie together. It works best if you use earphones so that the sound of the movie does not interfere.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#my_id', x: 100, y: 80, width: 300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
				title: 'Done',
				html: 'Thank you for finishing the tour. This site was made so that people can connect to each other in an easy way. It is still under construction, so watch this space',
				buttons: { Done: 2 },
				focus: 0,
				position: { container: '#my_video', x: 100, y: 20, width: 275, arrow: '' },
				submit: tourSubmitFunc
			}
			];
			$.prompt(tourStates);	
	    }
		(function localFileVideoPlayerInit(win) {
	    var URL = win.URL || win.webkitURL,
	        displayMessage = (function displayMessageInit() {
	            var node = document.querySelector('#message');

	            return function displayMessage(message, isError) {
	                node.innerHTML = message;
	                node.className = isError ? 'error' : 'info';
	            };
	        }()),
	        playSelectedFile = function playSelectedFileInit(event) {
	            file = this.files[0];

	            var type = file.type;

	            videoNode = document.querySelector('video');

	            var canPlay = videoNode.canPlayType(type);

	            canPlay = (canPlay === '' ? 'no' : canPlay);

	            var message = 'Can play type "' + type + '": ' + canPlay;

	            var isError = canPlay === 'no';

	            //displayMessage(message, isError);

	            if (isError) {
	                return;
	            }

	            var fileURL = URL.createObjectURL(file);

	            videoNode.src = fileURL;
	            console.log(videoNode.readyState);
	            console.log(file.name);
	            console.log(file.size);

	            //$("#stat_my_video").text(file.name);
	            //$("#stat_my_size").text(file.size);
	            stat_my_video = insert_spaces(file.name,8);
	            stat_my_size = file.size;
	            sendStatus();
	            updateMyStatus();
				videoNode.onpause = function() {
					
				   	console.log("Paused " + videoNode.currentTime);
	            	conn.send('{"action_change":"paused", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');

				};
				videoNode.onseeked = function() {
				    console.log("Seeked " + videoNode.currentTime);
				    if(Math.abs(videoNode.currentTime - last_received_time) > 1){ //do this so that a infinite loop does not happen (hopefully)
				   		conn.send('{"action_change":"seek", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
					}
				};
				videoNode.onplaying = function() {
				    console.log("Playing " + videoNode.currentTime);
				    //conn.send('{"action":"status", "time":"'+videoNode.currentTime+'"}');
				    conn.send('{"action_change":"play", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
				};
	        },
	        inputNode = document.querySelector('#video_file');
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
	    inputNode.addEventListener('change', playSelectedFile, false);
	}(window));
	//YOUTUBE CODE
		var my_timer;
      
      $("#the_player").hover(function(){
       // $("#the_player").css("background-color", "yellow");
        console.log("inside");
        time = player.getCurrentTime();
         my_timer = setInterval(function () {
            var cur_time = player.getCurrentTime();
            
            if (Math.abs(time-cur_time) > 1) {
                console.log("seeked from "+ time + " to " + cur_time);
                conn.send('{"user_action":"youtube", "user_event": "seeked", "youtube_time": "'+player.getCurrentTime()+'"}');
            }
            time = cur_time;
        }, 100);
        },function(){
        // $("#the_player").css("background-color", "pink");
        console.log("outside");
        clearInterval(my_timer);

    });
      $("#load_vid").click(function(e){
      	e.preventDefault();
        var vid_id = getQueryVariable($("#youtube_link").val(), 'v');
        if(vid_id){
          player.loadVideoById(vid_id);
          player.seekTo(0);
          player.pauseVideo();
          $("#youtube_link").val('');
          conn.send('{"user_action":"youtube", "user_event": "new_video", "new_vid_id": "'+vid_id+'"}');
        }
        console.log(vid_id);
      });
      function getQueryVariable(url_string, variable)
      {
            if(url_string == ''){
              return(false);
            }
             var query = url_string.split("?");
             var vars = query[1].split("&");
             for (var i=0;i<vars.length;i++) {
                     var pair = vars[i].split("=");
                     if(pair[0] == variable){return pair[1];}
             }
             return(false);
      }
      
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api?autohide=1";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      
      
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          playerVars: { 'autoplay': 0, 'rel':0},
          videoId: 'W8r-tXRLazs',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
        
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
       
        
        //event.target.playVideo();
        console.log("video ready");
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      var done = false;
      function onPlayerStateChange(event) {
        // if (event.data == YT.PlayerState.PLAYING && !done) {
        //   setTimeout(stopVideo, 6000);
        //   done = true;
        // }
        // if(event.data == YT.PlayerState.PAUSED){
	       //  if(partner_previous_state != YT.PlayerState.BUFFERING){
	       		 conn.send('{"user_action":"youtube", "user_event": "'+event.data+'", "youtube_time": "'+player.getCurrentTime()+'"}');

	       		 if(event.data == YT.PlayerState.BUFFERING && previous_state == YT.PlayerState.PLAYING){

	       		 	restart_after_buffer = setTimeout(function(){ player.playVideo();
	       		 		console.log("restarted");
	       		 	}, 2000);
	       		 }
	       		 if(event.data == YT.PlayerState.PAUSED && previous_state == YT.PlayerState.BUFFERING)
	       		{	
	       			clearTimeout(restart_after_buffer);
	       		}
	       		 previous_state = event.data;
	    //    	}
	    // }
    	// else{
    	// 	conn.send('{"user_action":"youtube", "user_event": "'+event.data+'", "youtube_time": "'+player.getCurrentTime()+'"}');
    	// }
        console.log(event.data);
      }
      function stopVideo() {
        player.stopVideo();
      }

	//END OF YOUTUBE CODE
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60494371-1', 'auto');
  ga('send', 'pageview');

</script>
