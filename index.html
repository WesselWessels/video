<!-- code for video credit: http://jsfiddle.net/dsbonev/cCCZ2/-->

<!DOCTYPE html>
<html>
	<head>
		<title>Watch videos together</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta name="description" content="SimulChat allows you and a friend to watch movies together while talking. It keeps the movie in sync. Perfect for long distance relationships and family that live far.">
		<meta name="keywords" content="watch movies together,watch videos together,webrtc,video call,voice call,sync video">
		<!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> -->
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<link rel="stylesheet" href="css/bootstrap.css">
		<link href="css/styles.css" rel="stylesheet">
		<script type="text/javascript" src="js/jquery-impromptu.js"></script>
		<link rel="stylesheet" href="css/jquery-impromptu.css">
		<script src="js/bootstrap.js"></script>
		<script src="js/scripts.js"></script>
 		<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>
 		<script type="text/javascript" src="js/jquery.linkify.min.js"></script>
 		<script type="text/javascript" src="js/ion.sound.min.js"></script>
 		<!--<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script> -->
 		<link href="//vjs.zencdn.net/4.12/video-js.css" rel="stylesheet">
 		<link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
 		<script src="js/paper-full.min.js"></script>
		<style type="text/css">
			video, input {
			    display: block;
			}
			input {
			    width: 100%;       
			}
			.info {
			    background-color: aqua;            
			}

			.error {
			    background-color: red;
			    color: white;
			}
			.a_search_result, .playlist_item{
            	padding-bottom: 5px;
          	}
          	.link_button{
          		color:black;
         	}
          	#my-video-div{
          		vertical-align: bottom;
          	}
          	#my-video{
			    transform: rotateY(180deg);
			    -webkit-transform:rotateY(180deg); /* Safari and Chrome */
			    -moz-transform:rotateY(180deg); /* Firefox */
			}
			#my_video{
				z-index: 1;
				width: 720px;
				height: 396px;

			}
			.shout_box {
				background:#1B9CE0; width:260px; overflow:hidden;
				position:fixed; bottom:0; right:10%; z-index:9;
			}
			.shout_box .header .close_btn {
				background: url(img/close_btn.png) no-repeat 0px 0px; 
				float:right; width:15px;
				height: 15px;
			}
			.shout_box .header .close_btn:hover {
				background: url(img/close_btn.png) no-repeat 0px -16px;
			}
			.shout_box .header .open_btn {
				background: url(img/close_btn.png) no-repeat 0px -32px;
				float:right; width:15px;
				height:15px;
			}
			.shout_box .header .open_btn:hover {
				background: url(img/close_btn.png) no-repeat 0px -48px;
			}
			.shout_box .header{
				padding: 10px 6px 6px 10px;
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif;
				font-weight: bold; color:#fff;
				border: 1px solid rgba(0, 39, 121, .76);
				border-bottom:none; cursor:pointer;
			}
			.shout_box .header:hover{
				background-color: #168ccc;
			}
			.shout_box .message_box {
				background: #FFFFFF; height: 200px;
				overflow:auto; border: 1px solid #CCC;
			}
			.shout_msg{
				margin-bottom: 2px; display: block;
				border-bottom: 1px solid #F3F3F3; padding: 0px 5px 5px 5px;
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif; color:#7C7C7C;
			}
			.me_shout_msg{
				color:#5CB85C;
			}
			.alert_shout_msg{
				color:#DB524B;
			}
			.message_box:last-child { 
				border-bottom:none;
			}
			time{ 
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif;
				font-weight: normal; float:right; color: #D5D5D5;
			}
			.shout_msg .username{
				margin-bottom: 3px;margin-top: 3px;
			}
			.shout_msg .my_username{
				color:#5CB85C;
			}
			.shout_msg .alert_msg{
				color:#DB524B;
			}
			.user_info input {
				width: 100%; height: 25px; border: 1px solid #CCC; border-top: none; padding: 3px 0px 0px 3px;
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif;
			}
			.shout_msg .username{
				font-weight: bold; display: block;
			}
			#floating_video{
				position: fixed;
				top: 70px; 
				left: 30px; 
				width: 180; 
				height: 120;
				z-index: 10;
			}
			.temp_video{
				position: fixed;
				top: 5px; 
				left: 5px; 
				width: 180; 
				height: 120;
				z-index: 10;
			}
			#my-video{
				position: fixed;
				top: 70px; 
				right: 30px; 
				width: 180; 
				height: 120;
				z-index: 10;
			}
			.volume_bot{
				position: fixed;
				bottom: 20px; 
				text-align: center;
				z-index: 10;
				opacity: 0.7;
			}
			.controls_fullscreen{
				position: fixed;
				bottom: 20px;
				right: 10px; 
				
				z-index: 10;
				opacity: 0.7;
			}
			.youtube_history{
			    margin: 0;
			    padding: 0;
			    height: 390px;
			    width: 100%;
			    display: block; 
			    /* border:solid #000 1px */
			}
			.content_bla{
			    padding:0;
			    overflow: scroll; 
			    overflow-x:hidden;
			    height:100%
			    /*-webkit-overflow-scrolling: touch;*/    
			}
			.related_box, .playlist_box{
			    margin: 0;
			    padding: 0;
			    height: 390px;
			    width: 100%;
			    display: block; 
			    /* border:solid #000 1px */
			}
			.related_items, .playlist_items{
			    padding:0;
			    overflow: scroll; 
			    overflow-x:hidden;
			    height:100%
			    /*-webkit-overflow-scrolling: touch;*/    
			}
			.results_box, .playlist_box{
			    margin: 0;
			    padding: 0;
			    height: 390px;
			    width: 100%;
			    display: block; 
			    /* border:solid #000 1px */
			}
			#the_results{
			    padding:0;
			    overflow: scroll; 
			    overflow-x:hidden;
			    height:100%
			    /*-webkit-overflow-scrolling: touch;*/    
			}
			#typing_msg{
				padding-left: 3em;
				font-style: italic;
			}
			#loading_info{
				position: absolute;
				top: 50%;
			}
			#online_people_list{
				color: #168ccc;
				height: 200px;
				overflow: auto;
			}
			#public_chat_area{
				color: #000000;
			}
			#public_chat_text{
				background: #FFFFFF;
				height: 200px;
				overflow: auto;
				
			}
			canvas[resize] {
			    width: 100%;
			    height: 100%;
			}
			canvas{
				border: 1px solid black;
			}
			.my_save{
				border: 1px solid black;
			}
			
			:-webkit-full-screen #call_section{
				width: 100%;
			  height: 100%;
			}
			 
			:-moz-full-screen #call_section{
				width: 100%;
			  height: 100%;
			}
			 
			:-ms-fullscreen #call_section{
				width: 100%;
			  height: 100%;
			}
			 
			:fullscreen #call_section{
				width: 100%;
			  height: 100%;
			}
			/*:fullscreen #section3 #my_video{
				width: 100%;
			  height: 100%;
			}*/
			:-webkit-full-screen:not(:root) {
			  width: 100% !important;
			  float: none !important;
			}
		</style>
	</head>

	<body>
		<div id="fb-root"></div>
		
		<nav class="navbar navbar-trans navbar-fixed-top" role="navigation">
		  	<div class="container">
			    <!-- Brand and toggle get grouped for better mobile display -->
			    <div class="navbar-header">
			      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
			        <span class="sr-only">Toggle navigation</span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			      </button>
			      <a class="navbar-brand" href="#section1">simulchat.com</a>
			    </div>
			    <!-- Collect the nav links, forms, and other content for toggling -->
			    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				    <ul class="nav navbar-nav">
				        <li ><a href="#section2">Connect</a></li>
				        <li ><a href="#call_section">Video Call</a></li>
				        <li ><a href="#section3">Watch Video</a></li>
				        <li ><a href="#section4">Watch YouTube</a></li>
				        <li ><a href="#draw_heading">Draw</a></li>
				        <li ><a href="#share_img">Fileshare</a></li>
				        <!-- <li ><a href="#section5">IRC Chat<span class="sr-only">(current)</span></a></li> -->
				    </ul>
					<div class="nav navbar-nav navbar-right">
						<a href="#section2"><button type="button" id="server_button" class="btn btn-danger navbar-btn tool_tip" title="Connection with server"><span class="glyphicon glyphicon-globe" aria-hidden="true"></span></button></a>
			      		<a href="#section2"><button type="button" id="user_button" class="btn btn-danger navbar-btn tool_tip" title="Connection with partner"><span class="glyphicon glyphicon-user" aria-hidden="true"></span></button></a>
			      		<a href="#call_section"><button type="button" id="call_button" class="btn btn-danger navbar-btn tool_tip" title="Voice call"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span></button></a>
			      		<a href="#call_section"><button type="button" id="video_call_button" class="btn btn-danger navbar-btn tool_tip" title="Video call"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span></button></a>
			    	</div>
			    </div><!-- /.navbar-collapse -->
		  	</div><!-- /.container-fluid -->
		</nav>
		<div id="floating_video">
			<video id="their-video-smaller" width="180" height="120" autoplay muted></video>
		</div>
		<section class="container-fluid" id="section1">
		<div class="container">
			<div style="text-align:center;">			
				<h1 id="page_title">Welcome to SimulChat</h1>
			</div>
			<div class="row" style="text-align:center;">
				<div class="col-md-3"></div>
				<div class="col-md-6">
					<h4>Watch videos together</h4>
					<h4>Watch YouTube together</h4>
					<h4>Talk to each other</h4>
				</div>
				<div class="col-md-3"></div>
			</div>
		</div>
		<div class="container">
			<div class="row" style="text-align:center;">
				<div class="col-md-3"></div>
				<div class="col-md-6">
					<button class="btn btn-success btn-lg" id="take_tour"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>Take Tour</button>
					<a href="#section2" class="btn btn-success btn-lg">Get Started</a>
					<button class="btn btn-success btn-lg" id="contact">Contact</button>
					<br><br>
					<div class="well">
						<div class="fb-like" data-href="https://facebook.com/simulchat" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
					</div>
				</div>
				<div class="col-md-3"></div>
			</div>
		</div>
		<!--<div class="container">
			<div style="text-align:center;">
				<h3>Public Chat</h3>
			</div>
			<div class="row">
				<div class="col-md-3">
					<div id="online_people">
						<h5>People online</h5>
						<ul class="list-group" id="online_people_list">
							
						</ul>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-horizontal" id="join_public_chat">
						<div class="form-group">
						    <label for="public_name" class="col-md-3 control-label">Your name: </label>
						    <div class="col-md-6">
						   		<input type="text" class="form-control" id="public_name" maxlength="20">
						   	</div>
						   	<div class="col-md-3">
						   		<button class="btn btn-success" id="join_chat">Join Chat</button>
						   	</div>
					 	</div>
					 	<div style="text-align:center;">
					 		<span id="public_chat_error"></span>
					 	</div>
					 </div>
					 
					 <div id="public_chat_area">
					 	<div id="public_chat_text">
					 	</div>
					 	<input name="public_message" id="public_message" type="text" placeholder="Type Message Here">
					 	<button class="btn btn-danger" id="leave_chat">Leave chat</button>
					 </div>
				</div>
				<div class="col-md-3">
					<h3>Disclaimer</h3>
					Public Chat is still under development. Be aware that everything you type here is public. More features coming soon.
				</div>
			</div>
		</div> -->
		</section>
		<section class="container-fluid" id="section2">
		<div style="text-align:center;">			
			<h1>Connect to Partner</h1>
		</div>	
		<br><br>
		<div class="container-fluid" id="connection_div">
			<div class="row">
				<div class="col-md-4"></div>
				<div class="col-md-4">
					<div class="form-horizontal">
						<div class="form-group">
						    <label for="my_id" class="col-md-4 control-label"><!-- <span title="This is your ID for this session" class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> --> Your ID is: </label>
						    <div class="col-md-8">
						   		<input type="text" class="form-control" id="my_id" readonly>
						   	</div>
					 	</div>
					 	<div class="form-group">
						    <label for="my_id" class="col-md-4 control-label">Partner ID: </label>
						    <div class="col-md-8">
							    <input type="text" class="form-control" id="connect_id" autocomplete="off">
							    <a href="#" class="btn btn-success" id="connect">connect</a>
							    <span id="disconnect_div">
				        		<a href="#" class="btn btn-danger" id="disconnect">disconnect</a>			        		
				        		</span>
						    </div>
					 	</div>	
					</div>
				</div>
				<div class="col-md-4"></div>
			</div>
		</div>	
		<div style="text-align:center;">
			<h2>Connection Status:</h2>
			<h3 id="connect_notify">Not Connected</h3>

		</div>
		<div style="text-align:center;">			
			<h1>No sign-up needed</h1>
			<div class="container">
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<div>No login, no password and no email.</div>
						<div>Simply send your ID to your partner, </div>
						<div>or enter your partner's ID and click connect.</div>
					</div>
					<div class="col-md-4"></div>
					
				</div>
			</div>
		</div>	
        </section>
        <section class="container-fluid" id="call_section">
         	<div style="text-align:center;">			
			<h1 id="talk_heading">Talk to each other</h1>
			<div class="container" id="the_call_controls">
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<a href="#" class="btn btn-success" id="voice_call"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> voice call</a>
				        <a href="#" class="btn btn-info" id="hang_up"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> cancel call</a>
				        <a href="#" class="btn btn-warning" id="end_voice_call"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> end voice</a>
				        <a href="#" class="btn btn-success" id="video_call"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span> video call</a>
				        <a href="#" class="btn btn-info" id="hang_up_video"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span> cancel video call</a>
				        <a href="#" class="btn btn-warning" id="end_video_call"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span> end video call</a>
				        <button class="btn btn-success" id="fullscreen_call"><span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span> Fullscreen</button>
					</div>
					<div class="col-md-4"></div>
				</div>
			</div>
			<video id="their-video" width="80%" height="60%" style="z-index:5;" autoplay></video>
			<div class="container-fluid">
				<div class="row" style="text-align:center;">
					<div class="col-md-12">
						
						<br>
						<div class="row">
							<div class="col-md-2"></div>
							<div class="col-md-8">
								<div class="row">
									<div class="col-md-1" style="z-index:0;"><span class="glyphicon glyphicon-volume-down" aria-hidden="true"></span></div>
									<div class="col-md-10" >
										<div id="partner_volume">
											<input type="range" id="slider" value="100"></input>
											<h3>Partner Volume</h3>
										</div>
										
									</div>
									<div class="col-md-1" style="z-index:0;"><span class="glyphicon glyphicon-volume-up" aria-hidden="true"></span></div>
								</div>
							</div>
							<div class="col-md-2"></div>
						</div>
					</div>
					<div id="my-video-div">
						<video id="my-video" muted="true" width="180" height="120" autoplay></video>
					</div>
				</div>
			</div>
		</div>	
        </section>
        
        <section class="container-fluid" id="section3">
        <div style="text-align:center;">			
			<h1>Watch Videos Together</h1>
		</div>	
		<br><br>
        <!-- <div class="container">
        	<div class="col-md-3">
        		<table class="table table-bordered" id="my_status_table">
        			<thead>
        				<th colspan="100%" style="text-align:center;">My Status</th>
        			</thead>
        			<tbody style="text-align:center;">
        				<tr>
        					<td>ID</td>
        					<td id="stat_my_id"></td>
        				</tr>
        				<tr>
        					<td>Microphone</td>
        					<td id="stat_my_mic">Inactive</td>
        				</tr>
        				<tr>
        					<td>Title</td>
        					<td id="stat_my_video"></td>
        				</tr>
        				<tr>
        					<td>Size</td>
        					<td id="stat_my_size"></td>
        				</tr>
        			</tbody>
        		</table>
        	</div> -->
	        <div id="video_div" style="text-align:center;">
				
				<video class="video-js vjs-default-skin" id="my_video" style="width:720px;height:480px;" controls >
				</video>
				<button class="btn btn-success" id="fullscreen_movie"><span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span> Fullscreen</button>
				<div class="container">
					<div class="row">
						<div class="col-md-3"></div>
						<div class="col-md-6">
							<input type="file" accept="video/mp4,video/webm,video/ogg,audio/*" id="video_file"/>
						</div>
						<div class="col-md-3"></div>
					</div>
					
				</div>
				
				
			</div>	
        	<!-- <div class="col-md-3">
        		<table class="table table-bordered" id="partner_status_table" style="word-wrap:break-word;">
        			<thead>
        				<th colspan="100%" style="text-align:center;">Partner Status</th>
        			</thead>
        			<tbody style="text-align:center;">
        				<tr>
        					<td>ID</td>
        					<td id="stat_partner_id"></td>
        				</tr>
        				<tr>
        					<td>Microphone</td>
        					<td id="stat_partner_mic"></td>
        				</tr>
        				<tr>
        					<td>Title</td>
        					<td id="stat_partner_video"></td>
        				</tr>
        				<tr>
        					<td>Size</td>
        					<td id="stat_partner_size"></td>
        				</tr>
        			</tbody>
        		</table>
        	</div>
		</div> -->
		<div style="text-align:center;">			
			<h1>Please note</h1>
			<div class="container">
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<div>Your video is NOT streamed to your partner.</div>
						<div>Both people need to open</div>
						<div>a video from their own computer.</div>
					</div>
					<div class="col-md-4"></div>	
				</div>
			</div>
		</div>	
		</section>
		<section class="container-fluid" id="section4">
		<div style="text-align:center;">			
			<h1 id="youtube_heading">Watch YouTube Together</h1>
		</div>	
		<div class="container-fluid" >
	      <div class="row">
	        <div class="col-md-3" style="margin:0;padding:0;">
	       		<h3>Playlist</h3>
	        	<div class="playlist_box">
	        		<div id="playlist_videos" class="playlist_items">
	        		</div>
	        	</div>
	        </div>

	        <div id="the_player" class="col-md-6">
	        	<div id="loading_info">Please wait while you and your partner are buffering.</div>
	        	<div id="player_only">
	        		
	          		<div id="player"></div>
	          		

	          	</div>
	          	<h3 id="youtube_title"></h3>
	        </div>
	        <div class="col-md-3">
	        	<h3>Related Videos</h3>
	        	<div class="related_box">
	        		<div id="related_videos" class="related_items">
	        		</div>
	        	</div>
	        </div>
	      </div>
	    </div>
	   <!--  <div style="text-align:center;">			
			<h2>Load new YouTube video</h2>
		</div>	 -->
		<!-- <div class="container">
			<div class="row" style="text-align:center;">
				<div class="col-md-4"></div>
				<div class="col-md-4">
					<div>This will load the video for you and your partner</div>
				</div>
				<div class="col-md-4"></div>
			</div>
		</div> -->
	    <div class="container">
	      	<div class="form-horizontal">
	      		<div class="form-group">
				    <label for="youtube_link" class="col-md-4 control-label"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search YouTube: </label>
				    <div class="col-md-4 input-group">
				   		<input type="text" placeholder="search YouTube" id="search_value" class="form-control">
				   		<!-- <button class="btn btn-success" id="search_button">load</button> -->
				   	</div>   
			 	</div>
				<div class="form-group">
				    <label for="youtube_link" class="col-md-4 control-label"><span class="glyphicon glyphicon-bookmark" aria-hidden="true"></span>  Enter link: </label>
				    <div class="col-md-4 input-group">
				   		<input type="text" placeholder="enter YouTube link" id="youtube_link" class="form-control">
				   		<!-- <a href="#" class="btn btn-success" id="load_vid">load</a> -->
				   	</div>
			 	</div>
		  	</div>
	    </div>
	    <div id="search_result">
          	<div class="row">
            	<div class="col-md-3"></div>
	            <div class="col-md-6">
	              	<div style="text-align:center;">
	                	<h1 id="results_heading">Search Results</h1>
	              	</div>
	              	<div class="results_box">
	              		<div id="the_results"></div>
	              	</div>
	            </div>
            	<div class="col-md-3"></div>
          	</div> 
        </div>  
		<div id="voice">
			<audio id="their_voice" controls autoplay></audio>
		</div>
		</section>
		<section id="draw">
			<script type="text/paperscript" canvas="canvas">
        var path;
        var their_path;
        their_path = new Path({
            
            strokeColor: 'red'
            // Select the path, so we can see its segment points:
            //fullySelected: true
        });

        // var textItem = new PointText({
        //     content: 'Click and drag to draw a line.',
        //     point: new Point(20, 30),
        //     fillColor: 'black',
        // });

        function onMouseDown(event) {
            // If we produced a path before, deselect it:
            if (path) {
                path.selected = false;
            }

            // Create a new path and set its stroke color to black:
            path = new Path({
               // segments: [event.point],
                strokeColor: 'black'
                // Select the path, so we can see its segment points:
               // fullySelected: true
            });

        }
        // path = new Path({
                
        //         strokeColor: 'black',
        //         // Select the path, so we can see its segment points:
        //         //fullySelected: true
        //     });
        //  path.importJSON('["Path",{"applyMatrix":true,"selected":true,"segments":[{"x":748,"y":463,"selected":true},[748,462],[752,457],[762,444],[778,422],[795,398],[811,374],[830,351],[849,333],[871,313],[890,298],[922,276],[943,262],[968,246],[993,232],[1017,221],[1031,217],[1052,213],[1069,210],[1091,209],[1109,209],[1128,209],[1146,214],[1163,221],[1176,227],[1196,236],[1209,242],[1225,246],[1239,248],[1250,248],[1257,246],[1261,239],[1262,230],[1264,201],[1267,177],[1270,141],[1271,121],[1271,101],[1267,91],[1256,86],[1235,84],[1194,82],[1159,81],[1116,80],[1080,80],[1059,80],[1037,84],[1021,89],[1005,95],[991,102],[981,106],[968,112],[958,116],[948,120],[939,123],[930,126],[924,126],[920,126]],"strokeColor":[0,0,0]}]');
        // // While the user drags the mouse, points are added to the path
        // at the position of the mouse:
        function onMouseDrag(event) {
            path.add(event.point);
            // console.log(event.point);
            // console.log(JSON.stringify(event.point));
            // var tempasdf = JSON.stringify(event.point);
            // var fdsa = JSON.parse(tempasdf);
            // console.log(fdsa);
            // var new_point = {x: fdsa[1], y: fdsa[2]};
            // path.add(new_point);
            // console.log(new_point);
           // var point = new Array({points: event.point});
            //point['points'].push(event.point);
            my_send(JSON.stringify(event.point));
            //my_send(path.exportJSON());
            //console.log(event);
           // console.log(path.exportJSON());
            // Update the content of the text item to show how many
            // segments it has:
            //textItem.content = 'Segment count: ' + path.segments.length;
        }

        // When the mouse is released, we simplify the path:
        function onMouseUp(event) {
            var segmentCount = path.segments.length;
            console.log(path.exportJSON());
            my_send('{"new_line":"true"}');
            // When the mouse is released, simplify it:
           // path.simplify(10);

            // Select the path, so we can see its segments:
            //path.fullySelected = true;

            // var newSegmentCount = path.segments.length;
            // var difference = segmentCount - newSegmentCount;
            // var percentage = 100 - Math.round(newSegmentCount / segmentCount * 100);
            // textItem.content = difference + ' of the ' + segmentCount + ' segments were removed. Saving ' + percentage + '%';
           
           // path.strokeColor = 'red';
            //my_send(path.exportJSON());
            //path.strokeColor = 'black';
        }
        window.new_point = function(new_point){
        	their_path.add(new_point);
        	paper.view.update();
        }
        window.new_line = function(){
        	their_path = new Path({
                
                strokeColor: 'red'
                // Select the path, so we can see its segment points:
                //fullySelected: true
            });
        }
        window.my_draw = function(to_draw){
        	 // their_path = new Path({
                
          //       strokeColor: 'red'
          //       // Select the path, so we can see its segment points:
          //       //fullySelected: true
          //   });
        	console.log(to_draw);
        	// var my_to_draw = JSON.parse(to_draw);
        	// my_to_draw[1][strokeColor][0] = 1;
        	// my_to_draw = JSON.stringify(my_to_draw);
        	// console.log(my_to_draw);
        	their_path.importJSON(to_draw);
        	paper.view.update();
        	//path.update();
         	// path.importJSON('["Path",{"applyMatrix":true,"selected":true,"segments":[{"x":748,"y":463,"selected":true},[748,462],[752,457],[762,444],[778,422],[795,398],[811,374],[830,351],[849,333],[871,313],[890,298],[922,276],[943,262],[968,246],[993,232],[1017,221],[1031,217],[1052,213],[1069,210],[1091,209],[1109,209],[1128,209],[1146,214],[1163,221],[1176,227],[1196,236],[1209,242],[1225,246],[1239,248],[1250,248],[1257,246],[1261,239],[1262,230],[1264,201],[1267,177],[1270,141],[1271,121],[1271,101],[1267,91],[1256,86],[1235,84],[1194,82],[1159,81],[1116,80],[1080,80],[1059,80],[1037,84],[1021,89],[1005,95],[991,102],[981,106],[968,112],[958,116],[948,120],[939,123],[930,126],[924,126],[920,126]],"strokeColor":[0,0,0]}]');
        }
        window.my_clear = function(){
        	paper.project.clear();
        	paper.view.update();
        	path = new Path({
               
                strokeColor: 'black'
                
            });
            their_path = new Path({
                
                strokeColor: 'red'
                // Select the path, so we can see its segment points:
                //fullySelected: true
            });
        }
        window.save_img = function(){
        	var canvas = document.getElementById("canvas");
        	var img = canvas.toDataURL("image/png");
        	$("#draw").append('<img class="my_save" height="250px" width="250px" src="'+img+'"/>');
        }
    </script>
    		<div style="text-align:center;">			
				<h1 id="draw_heading">Draw Together</h1>
			</div>
			<div class="container-fluid">
				<div class="row">
					<div class="col-md-1"></div>
					<div class="col-md-10">
						<canvas id="canvas" resize></canvas>
					</div>
					<div class="col-md-1">
						<button class="btn btn-danger" id="clear_paper">Clear</button>
						<button class="btn btn-success" id="save_paper">Save</button>
					</div>

				</div>

				
				
			</div>
		</section>
		<section id="share_img">
			<div style="text-align:center;">			
				<h1>Share Images and Files</h1>
			</div>
				<div class="container-fluid" >
					<div class="row">
						<div class="col-md-4"></div>
						<div class="col-md-4">
							<div class="form-horizontal">
								<div class="form-group">
								    <label for="share" class="col-md-4 control-label">Select File:</label>
								    <div class="col-md-8">
								   		<input id="share" class="form-control" type='file' onchange='openFile(event)'>
								   	</div>
							 	</div>
							</div>
						</div>
						<div class="col-md-4"></div>
					</div>
				</div>	
				<div style="text-align:center;">	
					<div id="progress">
						Received <span id="downloaded"></span> of <span id="file_size"></span> bytes
					</div>
					<div id="progress_sent">
						Sent <span id="sent"></span> of <span id="file_size_sent"></span> bytes
					</div>
				</div>
			
			<div class="container">
				<div class="row">
					<div class="col-md-3">
						<div style="text-align:center;">	
							<h3>Important</h3>
						</div>
						The filesharing feature is still experimental. Sending large files (over 200Mb)
						might crash your partner's browser. When trying to send large files, it seems that Firefox works best.
						Do not send files that you do not own the rights to.
					</div>
					<div class="col-md-6">
						<div style="text-align:center;">	
							<h3>Files Received</h3>
						</div>
						<table class="table table-bordered">
							<thead>
								<td>Preview</td>
								<td>Name</td>
								<td>Download</td>
							</thead>
							<tbody id="download_table">
								
							</tbody>
						</table>
					</div>
					<div class="col-md-3">
						<h3>Files Sent</h3>
						<ul id="sent_files">

						</ul>
					</div>

				</div>

			</div>
		</section>
		<!-- <section class="container-fluid" id="section5">
		<div style="text-align:center;">			
			<h1>Find Partner and exchange ID's</h1>
		</div>	
		<br>
		<div id="irc_chat" class="container">
			<div class="row">
				<div class="col-md-2"></div>
				<div class="col-md-8">
					<iframe src="https://kiwiirc.com/client/irc.kiwiirc.com/?&theme=basic##simulchat" style="border:0; width:100%; height:450px;" id="kiwi_irc_frame"></iframe>
				</div>
				<div class="col-md-2"></div>
			</div>
		</div>
		<br><br>
		</section> -->
		<!-- shoutbox -->
			<!-- CREDIT: http://www.sanwebe.com/2013/04/creating-shout-box-facebook-style -->
			<div class="shout_box">
				<div class="header">Text Chat <span class="badge" id="unread_badge"></span><span id="typing_msg">typing</span><div class="close_btn">&nbsp;</div></div>
			  	<div class="toggle_chat" style="display: none;">
				  	<div class="message_box"></div>
				    <div class="user_info">
				   		<input name="shout_message" id="shout_message" type="text" placeholder="Type Message Here"  /> 
				    </div>
			    </div>
			</div>
			<!-- shoutbox end -->
		<!--End of Tawk.to Script-->
	</body>
</html>

<script type="text/javascript" canvas="canvas">
		//$(document).ready(function(){
		if(!((navigator.userAgent.indexOf("Chrome") != -1) || (navigator.userAgent.indexOf("Firefox") != -1) || (navigator.userAgent.indexOf("Opera") != -1)))
		{
			alert("This website will only work in Chrome, Firefox and Opera");
			//$('html').empty();
		}
		var arrayBuffer;
		var buffer_array;
		var buffer_blob;
		var buffer_url;
		var chunk_size = 1024*16;
		var byte_index;
		var start;
		var the_file;// = new Uint8Array(input.files[0].size);
		var partner_file;
		var partner_byte_index;
		var partner_file_type;
	   	var partner_file_name;
	   	var partner_file_array;
		
		var openFile = function(event) {
		    start = 0
		  	byte_index = 0
		    var input = event.target;
		    the_file = new Uint8Array(input.files[0].size);
		    $("#file_size_sent").text(input.files[0].size);
		    $("#progress_sent").show();
		    //console.log("size: "+input.files[0].size);
		    console.log(input.files[0]);
		    var incrementer = 0;
		    var reader = new FileReader();
		    //data_temp = "";
		    my_data_send({new_file:true, new_size:input.files[0].size, new_type: input.files[0].type, new_name:input.files[0].name});
		    reader.onload = function(){
		      arrayBuffer = reader.result;
		      buffer_array = new Uint8Array(arrayBuffer);
		      my_data_send({new_pieces: buffer_array});
		      start = start + chunk_size;
		      // for(var i = 0; i < buffer_array.length; i++){
		      // 	the_file[byte_index++] = buffer_array[i];
		      // }
		      if(start >= input.files[0].size){
		      	 // buffer_blob = new Blob([the_file]);
		        //  buffer_url = window.URL.createObjectURL(buffer_blob);
		         my_data_send({done: true});
		         $("#sent_files").prepend('<li>'+input.files[0].name+'</li>');
		         $("#sent").text( '100.00%');
		         // $("#share_img").append('<a href="'+buffer_url+'" target="_blank" download="file.jpg">Link</a>');
		         // $("#share_img").append('<img src="'+buffer_url+'" target="_blank" download="file.jpg"/>');
		      }
		    
		      else{

		    	$("#sent").text(((start/input.files[0].size)*100).toFixed(2) +'%');
		      	reader.readAsArrayBuffer(input.files[0].slice(start, start+chunk_size));

		      }
		      //console.log(arrayBuffer);
		      
		    };
		    reader.readAsArrayBuffer(input.files[0].slice(0, chunk_size));
		  };
		var videoNode;
		var conn;
		var data_conn;
		var last_received_time = 0;
		var call;
		var original_title = "Watch videos together";
		var socket;
		//youtube variables
			var player;
     		var time; 
     		var partner_is_buffering = false;
     		var partner_previous_state = -2;
     		var restart_after_buffer;
     		var previous_state;
     		var yt_me_ready = true;
     		var yt_partner_ready = true;
     		var yt_ready_timeout;
     		var title_timeout;

     		var last_received_pause = 0;
     		var user_event;
		//end of youtube variables

		//var path;

		var data_temp = "";
		var data_length = 0;

		var stat_my_id = "-";
		var stat_my_mic = "-";
		var stat_my_video = "-";
		var stat_my_size = "-";
		var stat_partner_id = "-";
		var stat_partner_mic = "-";
		var stat_partner_video = "-";
		var stat_partner_size = "-";

		var window_focus;
		var connect_timeout;
		var previous_sender = "none";

		var typing_timeout;

		var last_typed_time = 0;

		var regex = /(https?:\/\/([-\w\.]+)+(:\d+)?(\/([\w\/_\.]*(\?\S+)?)?)?)/ig;

		var my_prompt = null;

		var unread_messages = 0;
		updateMyStatus();
		updatePartnerStatus();
		
		var file;
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

		function launchIntoFullscreen(element) {
		  if(element.requestFullscreen) {
		    element.requestFullscreen();
		  } else if(element.mozRequestFullScreen) {
		    element.mozRequestFullScreen();
		  } else if(element.webkitRequestFullscreen) {
		    element.webkitRequestFullscreen();
		  } else if(element.msRequestFullscreen) {
		    element.msRequestFullscreen();
		  }
		}
		function exitFullscreen() {
		  if(document.exitFullscreen) {
		    document.exitFullscreen();
		  } else if(document.mozCancelFullScreen) {
		    document.mozCancelFullScreen();
		  } else if(document.webkitExitFullscreen) {
		    document.webkitExitFullscreen();
		  }
		}
		var fullscreen = false;
	    var fullscreen_window = null;

		function video_size() {
			if(fullscreen){
				$('#their-video').css({
	            position: 'absolute',
				top:0, right:0,
			    bottom:0, left:0
	            // width: $(window).width(),
	            // height: $(window).height()
		        });
		        $('#their-video').attr('width', $(window).width()+'px');
		        $('#their-video').attr('height', $(window).height()+'px');
			}
			else{
				$("#their-video").css({'position': 'relative', 'margin-left':'auto', 'margin-right':'auto'});
				$('#their-video').attr('width', '50%');
		        $('#their-video').attr('height', '50%');
			}
	        
	        console.log($(window).width());
	    }
	    function movie_size(){
	    	if(fullscreen == true){
	    		$('#my_video').css({
	            position: 'absolute',
				top: 0, right:0,
			    bottom: 0, left:0,
	            width: $(window).width(),
	            height: $(window).height()
		        });
		        //$('#my_video').attr('width', $(window).width()+'px');
		        //$('#my_video').attr('height', $(window).height()+'px');
		        // $('#my_video').attr('width', '30%');
		        // $('#my_video').attr('height', '30%');
	    	}
	    	else{
				$("#my_video").css({'position': 'relative', 'margin-left':'auto', 'margin-right':'auto', 'width':'50%'});
				var wid = $("#my_video").width();
				var hei = Math.floor((wid * 9)/16);
				$("#my_video").css('height', hei);
				console.log(wid + " "+ hei);
				//$('#my_video').attr('width', '50%');
		       // $('#my_video').attr('height', '50%');
			}
	    }
	    video_size();
	       // movie_size();  
	    $(window).resize(function() {
	       // if(fullscreen){
	       // 	   video_size();
	       // }
	       // else{
	       // 		$("#their-video").css('position', 'relative');
	       // }	
	       video_size();
	       movie_size();      
	    });
	    //var fullscreenchange = 
	    
	    $(document).on('fullscreenchange', function(e){
	    	full_screen_changed()
	    });
	    $(document).on('mozfullscreenchange', function(e){
	    	full_screen_changed()
	    });
	    $(document).on('webkitfullscreenchange', function(e){
	    	full_screen_changed()
	    });
	    $(document).on('msfullscreenchange', function(e){
	    	full_screen_changed()
	    });
	    function full_screen_changed(){
	    	if(document.fullScreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullScreenElement){
	    		fullscreen = true; 
	    		 		
	    	}
	    	else{
	    		fullscreen = false;
	    		// fullscreen_call();   
	    	}
	    	if(fullscreen_window == 'call'){
	    		fullscreen_call();  
	    	}
	    	if(fullscreen_window == 'movie'){
	    		console.log("MOVIE Fullscreen");
	    		fullscreen_movie();
	    	}
	    }
	    function fullscreen_call(){
	    	if(fullscreen == true){
	    		$("#partner_volume").addClass('volume_bot');
	    		$("#the_call_controls").addClass('controls_fullscreen');
	    		video_size();
	    		console.log('Fullscreen');
	    		$("#fullscreen_call").hide();
	    	}
	    	else{
	    		$("#partner_volume").removeClass('volume_bot');
	    		$("#the_call_controls").removeClass('controls_fullscreen');
	    		console.log('not Fullscreen');
	    		$("#their-video").css('position', 'relative');
	    		$("#fullscreen_call").show();
	    		fullscreen = null;
	    	}
	    }
	    function fullscreen_movie(){
	    	movie_size();
	    	if(fullscreen){
	    		$('.temp_video').remove();
		    		if(call != null && call.open == true && call.metadata == 'video'){
		    			$("#section3").append('<div class="temp_video"><video class="temp_vid" width="180" height="120" autoplay muted></video></div>');
		    		$('.temp_vid').prop('src', URL.createObjectURL(window.remoteStream));
	    		}
	    		
	    	}
	    	else{
	    		$('.temp_video').remove();
	    	}
	    }
		function is_typing(){
			clearInterval(typing_timeout);

			$("#typing_msg").show();
			typing_timeout = setTimeout(function(){
				$("#typing_msg").hide();
			}, 10000);
		}
		function not_typing(){
			clearInterval(typing_timeout);
			$("#typing_msg").hide();
		}
		function my_send(data){
			if(conn != null && conn.open == true){
				conn.send(data);
				console.log("Sent: "+ data);
			}
			else{
				console.log("not connected");
			}
		}
		function my_data_send(data){
			if(data_conn != null && data_conn.open == true){
				data_conn.send(data);
				//console.log("Sent DATA: "+ data);
			}
			else{
				//console.log("data not connected");
			}
		}
		function my_scroll(id){
		   var target = $(id);
		    //console.log(this.hash);
		    target = target.length ? target : $('[name=' + id.slice(1) +']');
		    //console.log(target);
		    if (target.length) {
		      $('html,body').animate({
		        scrollTop: target.offset().top - 50
		      }, 750);
		      return false;
		    }
		}

		function get_mic(){
			navigator.getUserMedia({audio: true, video: false}, function(stream){
	        	window.localStream = stream;
	        	//$("#stat_my_mic").text("Active");
	        	stat_my_mic = "active";
	        	sendStatus();
	        	updateMyStatus();
	      	},function(){
	      		console.log("Microphone not granted");
	      	});
		}
		function get_cam(){
			navigator.getUserMedia({audio: true, video: true}, function(stream){
	        	window.localStream = stream;
	        	$('#my-video').prop('src', URL.createObjectURL(stream));
	        	//$('#their-video').prop('src', URL.createObjectURL(stream));
	        	//$("#stat_my_mic").text("Active");
	        	//stat_my_mic = "active";
	        	//sendStatus();
	        	//updateMyStatus();
	      	},function(){
	      		console.log("Video not granted");
	      	});
		}
		function change_status_button(button, set){
			$("#"+button).removeClass("btn-default btn-success btn-danger btn-warning");
			if(set=="red"){
				$("#"+button).addClass("btn-danger");
			}
			else if(set=="green"){
				$("#"+button).addClass("btn-success");
			}
			else if(set=="yellow"){
				$("#"+button).addClass("btn-warning");
			}
			else{
				$("#"+button).addClass("btn-default");
			}
		}
		function update_badge(){
			if(unread_messages == 0 || $(".toggle_chat").css('display') == "block"){
				//unread_messages = 0; //unsure if this is needed
				$("#unread_badge").text('');
				
			}
			else{
				//unread_messages = unread_messages +1;
				$("#unread_badge").text(unread_messages);
			}
			if(unread_messages > 0 && window_focus == false){
				var tab_message = (unread_messages == 1) ? 'message':'messages';
				document.title = '['+unread_messages+'] '+tab_message+' - SimulChat';
			}

			
		}

		

		//get_mic();
		var words = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","s","t","u","v","w","x","z","aardvark","absurd","adrift","adult","ahead","aimless","allow","alone","ammo","ancient","apple","artist","atlas","baboon","backward","banjo","beaming","bedlamp","beehive","beeswax","blackjack","blowtorch","bookshelf","briefcase","button","cement","choking","chopper","classic","cleanup","cobra","concert","adviser","article","cranky","crucial","eating","erase","escape","fracture","freedom","glitter","goggles","goldfish","indoors","indulge","inverse","island","jawbone","keyboard","kiwi","music","newborn","optic","prefer","pupil","puppy","python","rematch","revenge","reward","robust","select","shadow","solo","stairway","standard","stapler","sugar","tiger","tonic","tracker","tunnel","vapor","wallet","the","name","very","and","just","form","much","great","think","you","say","that","help","low","was","line","for","before","turn","cause","with","same","mean","differ","his","move","they","right","boy","old","one","too","have","does","this","tell","from","sentence","set","had","want","hot","air","but","well","some","also","what","play","there","small","end","can","put","out","home","other","read","were","hand","all","port","your","large","when","spell","add","use","even","word","land","how","here","said","must","big","each","high","she","such","which","follow","act","their","why","time","ask","men","will","change","way","went","about","light","many","kind","then","off","them","need","would","house","write","picture","like","try","these","again","her","animal","long","point","make","mother","thing","world","see","near","him","build","two","self","has","earth","look","father","more","head","day","stand","could","own","page","come","should","did","country","found","sound","answer","school","most","grow","number","study","who","still","over","learn","know","plant","water","cover","than","food","call","sun","first","people","thought","may","let","down","keep","side","eye","been","never","now","last","find","door","any","between","new","city","work","tree","part","cross","take","since","get","hard","place","start","made","might","live","story","where","saw","after","far","back","sea","little","draw","only","left","round","late","man","run","year","came","while","show","press","every","close","good","night","real","give","life","our","few","under","stop","open","ten","seem","simple","together","several","next","vowel","white","toward","children","war","begin","lay","got","against","walk","pattern","example","slow","ease","center","paper","love","often","person","always","money","music","serve","those","appear","both","road","mark","map","book","science","letter","rule","until","govern","mile","pull","river","cold","car","notice","feet","voice","care","fall","second","power","group","town","carry","fine","took","certain","rain","fly","eat","unit","room","lead","friend","cry","began","dark","idea","machine","fish","note","mountain","wait","north","plan","once","figure","base","star","hear","box","horse","noun","cut","field","sure","rest","watch","correct","color","able","face","pound","wood","done","main","beauty","enough","drive","plain","stood","girl","contain","usual","front","young","teach","ready","week","above","final","ever","gave","red","green","list","though","quick","feel","develop","talk","sleep","bird","warm","soon","free","body","minute","dog","strong","family","special","direct","mind","pose","behind","leave","clear","song","tail","measure","produce","state","fact","product","street","black","inch","short","lot","numeral","nothing","class","course","wind","stay","question","wheel","happen","full","complete","force","ship","blue","area","object","half","decide","rock","surface","order","deep","fire","moon","south","island","problem","foot","piece","yet","told","busy","knew","test","pass","record","farm","boat","top","common","whole","gold","king","possible","size","plane","heard","age","best","dry","hour","wonder","better","laugh","true.","thousand","during","ago","hundred","ran","check","remember","game","step","shape","early","yes","hold","hot","west","miss","ground","brought","interest","heat","reach","snow","fast","bed","bring","sing","sit","listen","perhaps","fill","table","east","travel","less","language","morning","among"];
	    //alert(words[Math.floor(Math.random()*words.length)]);
	    var random_id = words[Math.floor(Math.random()*words.length)]+"-"+words[Math.floor(Math.random()*words.length)]+"-"+Math.floor(Math.random()*980+10);
    	var peer = new Peer(random_id,{ key: 'yqyt65uodybbuik9', debug: 3, config: {'iceServers': [
	      { url: 'stun:stun.l.google.com:19302' },
				{
					url: 'turn:numb.viagenie.ca',
					credential: 'simulchat',
					username: 'simulchat@gmail.com'
				}// Pass in optional STUN and TURN server for maximum network compatibility
	    ]}});
		//var peer = new Peer(random_id, { host: 'chat.simulchat.com', port: 9000, path: '/myapp'});
	    peer.on('open', function(){
	    	console.log(peer.id);
	    	change_status_button("server_button","green");
	    	$("#my_id").val(peer.id);
	    	stat_my_id = peer.id;
	    	updateMyStatus();
	    	//$("#stat_my_id").text(peer.id);
	    });
	    peer.on('error', function(error){
	    	console.log("Cannot connect to peerserver");
	    });
	    peer.on('connection',function(conn){	
	    	console.log(conn.peer);
	    	//var the_peer = conn.peer;
	    	$("#connect_id").val(conn.peer);
	    	//$("#connected_id").text("hello");
	    	//alert(conn.peer);
	    	my_connect(conn);	
	    });
	    peer.on('call', function(call_in){
	    	exitFullscreen();
	      	call = call_in;
	      	console.log("Received call");
	      	console.log(call.metadata);
	      	if(call.metadata == "voice"){
		      	if(window.localStream == null || window.localStream.getAudioTracks().length == 0){
		      		get_mic();
		      		my_send('{"call_status": "mic_inactive"}');
		      		if(my_prompt != null){
		      			my_prompt.close();
		      		}
		      		my_prompt = new Impromptu("There is an incoming voice call from your partner, but your microphone is not activated. Please activate your microphone.", {
						title: "Activate your microphone",
						buttons: { "OK": true}
						//timeout: 20000,
					});
		      	}
		      	else{
		      		if(my_prompt != null){
		      			my_prompt.close();
		      		}
		      		my_prompt = new Impromptu("There is an incoming voice call from your partner.", {
						title: "Incoming call",
						buttons: { "Answer": true, "Not now": false },
						//timeout: 20000,
						submit: function(e,v,m,f){
							// use e.preventDefault() to prevent closing when needed or return false. 
							// e.preventDefault(); 
							if(v == true){
								if(window.localStream.getVideoTracks().length > 0){
	    							window.localStream.getVideoTracks()[0].enabled = false;
	    						}	
						  		call.answer(window.localStream);
					      		call.on('stream', function(stream){
				    				window.remoteStream = stream;

						      		change_status_button("call_button","green");
						        	$('audio').prop('src', URL.createObjectURL(stream));
						        	$("#end_voice_call").show();
							    	$("#voice_call").hide();
					  	 		});
				  	  			call.on('close', function(){
							      	change_status_button("call_button","red");
							      	exitFullscreen();
							  	  	$("#end_voice_call").hide();
								    $("#voice_call").show();
				  	  			});
							}
							else{
								my_send('{"call_status": "hang_up"}');
							}
							console.log("Value clicked was: "+ v);
						}
					});
		 	 	}
	 		}
	 		if(call.metadata == "video"){
		      	if(window.localStream == null || window.localStream.getVideoTracks().length == 0){
		      		get_cam();
		      		my_send('{"call_status": "cam_inactive"}');
		      		if(my_prompt != null){
		      			my_prompt.close();
		      		}
		      		my_prompt = new Impromptu("There is an incoming video call from your partner, but your camera is not activated. Please activate your camera.", {
						title: "Activate your Camera",
						buttons: { "OK": true}
						//timeout: 20000,
					});
		      	}
		      	else{
		      		if(my_prompt != null){
		      			my_prompt.close();
		      		}
		      		my_prompt = new Impromptu("There is an incoming video call from your partner.", {
						title: "Incoming video call",
						buttons: { "Answer": true, "Not now": false },
						//timeout: 20000,
						submit: function(e,v,m,f){
							// use e.preventDefault() to prevent closing when needed or return false. 
							// e.preventDefault(); 
							if(v == true){
								if(window.localStream.getVideoTracks().length > 0){
	    							window.localStream.getVideoTracks()[0].enabled = true;
	    						}
	    						my_scroll("#talk_heading");
						  		call.answer(window.localStream);
					      		call.on('stream', function(stream){
				    				window.remoteStream = stream;

						      		change_status_button("video_call_button","green");
						        	$('#their-video').prop('src', URL.createObjectURL(stream));
						        	$('#their-video-smaller').prop('src', URL.createObjectURL(stream));
						        	$("#end_video_call").show();
							    	$("#video_call").hide();
							    	$("#hang_up_video").hide();
					  	 		});
				  	  			call.on('close', function(){
							      	change_status_button("video_call_button","red");
							  	  	$("#end_video_call").hide();
								    $("#video_call").show();
								    $("#floating_video").hide();
								    exitFullscreen();
				  	  			});
							}
							else{
								my_send('{"call_status": "hang_up_video"}');
							}
							console.log("Value clicked was: "+ v);
						}
					});
		 	 	}
	 		}
	    });
		peer.on('disconnected', function(){
			console.log("Disconnected from server");
			change_status_button("server_button","red");
		});
		peer.on('error',function(err){
			console.log("peer error: " + err);
		});
	    function insert_space(str,pos){
	    	var str_length = str.length;
	    	return str.substring(0,pos) + " " + str.substring(pos, str_length);
	    }
	    function insert_spaces(str, chars){
	    	var str_length = str.length;
	    	var number_of_spaces = Math.floor((str_length-1)/chars);
	    	var return_string = "";
	    	for(var i = 0; i <number_of_spaces+1; i++){
	    		return_string = return_string + str.substring(i*chars,(i+1)*chars) + " ";
	    	}
	    	return return_string;
	    }
	    function get_ping(){
	    	
			// var d = new Date();
			// var n = d.getTime(); 
			my_send('{"ping":"'+window.performance.now()+'"}');
	    }
	    function change_volume(volume){
	    	$("#their-video").prop("volume", volume);
	    	$("#their_voice").prop("volume", volume);
	    }
	    function my_connect(connection){
	    	if(connection.metadata == 'connection'){
		    	conn = connection;
		    	clearTimeout(connect_timeout);
		    	connect_timeout = setTimeout(function(){
		    		
		    		if(my_prompt != null){
			      		my_prompt.close();
			      	}	
			      	if(conn.open == false){
			      		$("#connect").show();
		    			$("#disconnect").hide();
			      		my_prompt = new Impromptu("The connection could not be established. Please try again. If it fails a few times, please make sure your browser is up to date. Note that some networks do not allow these type of connections.", {
							title: "Could not connect",
							buttons: { "OK": true}
						});
			    		$("#connect_notify").html('Try again');
		    		}
		    	}, 10000);
		    	$("#connect_notify").html('<span style="color:orange;">Trying to connect</span>');
		    	conn.on('open',function(){
		    		clearTimeout(connect_timeout);
		    		my_scroll("#section2");
		    		$("#connected_id").text(conn.peer);
		    		$("#connect_notify").html('<span style="color:green;">Connected</span>');
		    		stat_partner_id = conn.peer;
		    		updatePartnerStatus();
		    		change_status_button("user_button", "green");
		    		console.log("Connected");
		    		$("#connect").hide();
		    		$("#disconnect").show();
		    		$("#disconnect_div").show();
		    		ga('send', 'event', 'Connection', 'Connect');
		    		
			    	conn.on('data', function(data){
			    		var message_json = jQuery.parseJSON(data);
			    		if(message_json.typing == "true"){
			    			is_typing();
			    		}
			    		if(message_json.new_line == "true"){
			    			new_line();
			    		}
			    		if(message_json.clear_paper == "true"){
			    			my_clear();
			    		}
			    		if(message_json[0] == "Point"){
			    			var a_new_point = {x: message_json[1], y: message_json[2]};
			    			new_point(a_new_point);
			    		}
			    		if(message_json[0] == 'Path'){
			    			my_draw(message_json);
			    		}
			    		if(message_json.textMessage == "true"){
			    			var received_message = strip(decodeURIComponent(message_json.message));
			    			
			    			var d= new Date();
							var msg_time = d.toLocaleTimeString();
							var new_message;
							if(previous_sender!="partner"){
							 	new_message = '<div class="shout_msg"><time>'+msg_time+'</time><span class="username">Partner</span><span class="message">'+received_message+'</span></div>';
							 	previous_sender = "partner";
							}
							else{
								new_message = '<div class="shout_msg"><time>'+msg_time+'</time><span class="message">'+received_message+'</span></div>';
							}
							//append data into messagebox with jQuery fade effect!
							$(new_message).linkify().hide().appendTo('.message_box').fadeIn();
			
							//keep scrolled to bottom of chat!
							var scrolltoh = $('.message_box')[0].scrollHeight;
							$('.message_box').scrollTop(scrolltoh);
			    			console.log(received_message);
			    			ion.sound.play("message_drop");
			    			unread_messages = unread_messages +1;
			    			not_typing();
			    			update_badge();
			    		}
			    		if(message_json.ping != null){
			    			my_send('{"pingback":"'+message_json.ping+'"}');
			    		}
			    		if(message_json.pingback != null){
			    // 			var d = new Date();
							// var n = d.getTime(); 
							console.log((window.performance.now()- message_json.pingback)/2 + "ms");
			    		}
			    		if(message_json.call_status == "hang_up"){
			    			if(call){
		   						call.close();
		   					}
			    			$("#hang_up").hide();
			    			$("#voice_call").show();
			    		}
			    		if(message_json.call_status == "hang_up_video"){
			    			if(call){
		   						call.close();
		   					}
			    			$("#hang_up_video").hide();
			    			$("#video_call").show();
			    		}
			    		if(message_json.call_status == "mic_inactive"){
			    			if(call){
		   						call.close();
		   					}
			    			$("#hang_up").hide();
			    			$("#voice_call").show();
			    			if(my_prompt != null){
			      				my_prompt.close();
			      			}
			      			my_prompt = new Impromptu("Your partner's microphone is not activated. Please try again.", {
								title: "Partner microphone inactive",
								buttons: { "OK": true}
							});
			    		}
			    		if(message_json.call_status == "cam_inactive"){
			    			if(call){
		   						call.close();
		   					}
			    			$("#hang_up_video").hide();
			    			$("#video_call").show();
			    			if(my_prompt != null){
			      				my_prompt.close();
			      			}
			      			my_prompt = new Impromptu("Your partner's camera is not activated. Please try again.", {
								title: "Partner camera inactive",
								buttons: { "OK": true}
							});
			    		}
			    		if(message_json.action_change == "paused" && !videoNode.paused){
			    			videoNode.currentTime = message_json.time_of_movie;
			    			videoNode.pause();
			    		}
			    		if(message_json.action_change == "play" && videoNode.paused){
			    			//videoNode.currentTime = message_json.time_of_movie;
			    			if(Math.abs(videoNode.currentTime - message_json.time_of_movie) > 1){
			    					videoNode.currentTime = message_json.time_of_movie;
			    			}
			    			videoNode.play();
			    		}
			    		if(message_json.action_change == "seek"){
			    			if(last_received_time != message_json.time_of_movie){
			    				last_received_time = message_json.time_of_movie;
			    				if(Math.abs(videoNode.currentTime - message_json.time_of_movie) > 1){
			    					videoNode.currentTime = message_json.time_of_movie;
			    				}
			    			}
			    		}
			    		if(message_json.stat_mic != null)
			    		{
			    			stat_partner_mic = message_json.stat_mic;
			    			updatePartnerStatus();
			    		}
			    		if(message_json.stat_video != null)
			    		{
			    			stat_partner_video = message_json.stat_video;
			    			updatePartnerStatus();
			    		}
			    		if(message_json.stat_size != null)
			    		{
			    			stat_partner_size = message_json.stat_size;
			    			updatePartnerStatus();
			    		}
			    		if(message_json.user_action =='youtube')
			    		{
			    			user_event = message_json.user_event;
			    			if(user_event == YT.PlayerState.PAUSED){
			    				if(player.getPlayerState() != YT.PlayerState.PAUSED )
			    				{
			    					player.seekTo(message_json.youtube_time);
			    					player.pauseVideo();
			    				}
			    				last_received_pause = window.performance.now();
			    			}
			    			if(user_event == YT.PlayerState.BUFFERING){
			    				partner_is_buffering = true;
			    				if(player.getPlayerState() != YT.PlayerState.PAUSED)
			    				{
			    					player.seekTo(message_json.youtube_time);
			    					player.pauseVideo();
			    				}
			    				last_received_pause = window.performance.now();
			    			}
			    			if(user_event == YT.PlayerState.PLAYING){
			    				partner_is_buffering = false;
			    				if(player.getPlayerState() != YT.PlayerState.PLAYING && yt_me_ready == true)
			    				{
			    					player.seekTo(message_json.youtube_time);
			    					player.playVideo();
			    				}
			    			}	
			    			if(user_event == 'seeked'){
			    				if(Math.abs(player.getCurrentTime() - message_json.youtube_time) > 1)
			    				{
			    					player.seekTo(message_json.youtube_time);
			    					time = message_json.youtube_time;
			    				}
			    			}
			    			if(user_event == 'ready'){
			    				yt_partner_ready = true;
			    				if(yt_me_ready == true){
			    					$("#player_only").css('visibility', 'visible');
			    					$("#loading_info").hide();
			    				}
			    			}
			    			if(user_event == 'load_playlist'){
			    				add_to_playlist(message_json.video_id,message_json.video_title,'Partner');
			    			}
			    			if(user_event == 'new_video'){
			    				player.loadVideoById(message_json.new_vid_id);
			    				remove_from_playlist(message_json.new_vid_id);
			    				get_related(message_json.new_vid_id);
			    				clearInterval(title_timeout);
			    				clearInterval(yt_ready_timeout);
					          	yt_me_ready = false;
					          	yt_partner_ready = false;

					          	//player.pauseVideo();
					          	//player.playVideo();
					          	player.seekTo(0);
					          	$("#player_only").css('visibility', 'hidden');
					          	$("#loading_info").show();
					          	title_timeout =  setInterval(function(){
					          		console.log("title: "+player.getVideoData().title);
					          		if(player.getPlayerState() != -1){
					          			$("#youtube_title").text(player.getVideoData().title);
					          			
					          			player.pauseVideo();
					          			player.seekTo(0);
					          			clearInterval(title_timeout);
					          		}
					          		else{
					          			player.seekTo(0);
					          			player.playVideo();
					          		}
					          	}, 1000);
					          	yt_ready_timeout = setInterval(function(){
			          				if(yt_me_ready == true && yt_partner_ready == true){
			          					clearInterval(yt_ready_timeout);
			          					$("#youtube_title").text(player.getVideoData().title);
			          					my_send('{"user_action":"youtube", "user_event":"ready"}');
			          					console.log('ready');
			          					player.playVideo();
			          					$("#player_only").css('visibility', 'visible');
			          					$("#loading_info").hide();
			          				}
			          				else if(yt_me_ready == true && yt_partner_ready == false){
			          					clearInterval(yt_ready_timeout);
			          					$("#youtube_title").text(player.getVideoData().title);
			          					my_send('{"user_action":"youtube", "user_event":"ready"}');
			          					console.log('ready');
			          				}
			          				else{
			          					if(player.getVideoLoadedFraction()*player.getDuration() > 10){ //amount of seconds loaded
			          						yt_me_ready = true;
			          					}
			          					else{
				      						player.playVideo();
				      						player.pauseVideo();
				      					}
			          				}
			          			},1000);

			    			}	
			    			partner_previous_state = user_event;
			    		}
			    		
			    		console.log('Received ' + data);
		    		});	
				
		   		});
		   		conn.on('close', function(){
		   			exitFullscreen();
		   			console.log("Disconnected");
		   			$("#connect_notify").html('<span style="color:red;">Disconnected</span>');
		   			my_scroll("#section2");
		    		change_status_button("user_button", "red");
		   			if(call){
		   				call.close();
		   			}
		   			$("#connect").show();
		    		$("#disconnect_div").hide();
		    		player.pauseVideo();
		   		});
		   		conn.on('error', function(err){
		   			console.log(err);
		   		});
		   		
	   		}
	   		else if(connection.metadata == 'data'){
	   			data_conn = connection;
	   			//my_data_send({new_file:true, new_size:input.files[0].size, new_type: input.files[0].type, new_name:input.files[0].name});
	   			data_conn.on('open', function(){
	   				console.log("data_conn open");
	   				data_conn.on('data', function(data){
	   					if(data.new_file == true){
	   						partner_file = data.new_size;
	   						partner_file_type = data.new_type;
	   						partner_file_name = data.new_name;
	   						partner_byte_index = 0;
	   						partner_file_array = new Array();
	   						$("#file_size").text(data.new_size);
	   						$("#progress").show();
	   					}
	   					if(data.new_pieces != null){
	   						var temp_buff = new Uint8Array(data.new_pieces);
	   						// for(var i =0; i<temp_buff.length; i++){
	   						// 	partner_file[partner_byte_index++] = temp_buff[i];
	   						// }
	   						partner_byte_index += temp_buff.length;
	   						partner_file_array.push(temp_buff);
	   						$("#downloaded").text(((partner_byte_index/partner_file)*100).toFixed(2) +'%');
	   					}
	   					if(data.done == true){
	   						 var partner_buffer_blob = new Blob(partner_file_array,{type : partner_file_type});
					          var partner_buffer_url = window.URL.createObjectURL(partner_buffer_blob);
					         //my_data_send({done: true});
					         if(partner_file_type.split('/')[0] == 'image'){
					         	//$("#share_img").append('<a href="'+partner_buffer_url+'"  download="'+partner_file_name+'"><img src="'+partner_buffer_url+'" height="200px" width="300px"/></a>');
					         	$("#download_table").prepend('<tr><td><img src="'+partner_buffer_url+'" height="150px" width="200px" download="'+partner_file_name+'"/></td><td>'+partner_file_name+'</td><td><a href="'+partner_buffer_url+'"  download="'+partner_file_name+'"><span style="color:#ddd">download</span></a></td></tr>');
					         }else{
					         	//$("#share_img").append('<br><a href="'+partner_buffer_url+'"  download="'+partner_file_name+'">'+partner_file_name+'</a><br>');
					         	$("#download_table").prepend('<tr><td></td><td>'+partner_file_name+'</td><td><a href="'+partner_buffer_url+'"  download="'+partner_file_name+'"><span style="color:#ddd">download</span></a></td></tr>');
					         }
					         
					         //$("#share_img").append('<img src="'+partner_buffer_url+'" target="_blank" download="file.jpg"/>');
	   						//$("#share_img").append('<img height="300px" width="500px" src="'+data_temp+'" controls/>');
	   						
	   					}
	   					//console.log(data);
	   				});
	   			});
	   			console.log("woohoo");
	   		}
	   		console.log("meta: " +connection.metadata);
	    }

	    function updateMyStatus(){
	    	$("#stat_my_id").text(stat_my_id);
	    	$("#stat_my_mic").text(stat_my_mic);
	    	$("#stat_my_video").text(stat_my_video);
	    	$("#stat_my_size").text(stat_my_size);
	    }

	    function updatePartnerStatus(){
	    	$("#stat_partner_id").text(stat_partner_id);
	    	$("#stat_partner_mic").text(stat_partner_mic);
	    	$("#stat_partner_video").text(stat_partner_video);
	    	$("#stat_partner_size").text(stat_partner_size);
	    }

	    function sendStatus(){
	    	//if(conn != null && conn.open == true){
	    		my_send('{"stat_mic":"'+stat_my_mic+'","stat_video":"'+stat_my_video+'","stat_size":"'+stat_my_size+'"}');
	    	//}
	    }

	    function takeTour(){
	    	var tourSubmitFunc = function(e,v,m,f){
			if(v === -1){
				$.prompt.prevState();
				return false;
			}
			else if(v === 1){
				$.prompt.nextState();
				return false;
			}
			},
			tourStates = [
				{
					title: 'Welcome to Simulchat!',
					html: 'Simulchat allows you to watch videos with someone over the internet. Both people must have their own copy video to play, preferably the same video. The video is NOT streamed.',
					buttons: { Next: 1 },
					focus: 0,
					position: { container: '#take_tour', x: -200, y: 0, width: 400, arrow: '' },
					submit: tourSubmitFunc
				},
				{
					title: 'Your ID',
					html: 'This is your ID for this session. Give it to your partner and they can connect to you!',
					buttons: { Next: 1 },
					focus: 0,
					position: { container: '#my_id', x: 200, y: -10, width: 400, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: 'Their ID',
					html: 'If you have your partner\'s ID, enter it here and click Connect',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#connect_id', x: 200, y: -10, width: 400, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: 'Voice Call',
					html: 'When you are connected to your partner, you can enable a voice call so that you can speak while watching the movie together. It works best if you use earphones so that the sound of the movie does not interfere.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#voice_call', x: 10, y: 30, width: 300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Video Call',
					html: 'You can also video call your partner',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#video_call', x: 10, y: 30, width: 300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: "Open a video",
					html: 'Click here to open a video file from your computer. Your partner must also open a video on their side. The video is NOT streamed.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#video_file', x: 30, y: 25, width: 400, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Watch Together',
					html: 'If you are connected to your partner and you both have a movie file selected, you can watch the movie here together. If you pause, they pause. If you skip, they skip and vice versa.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#my_video', x: 100, y: 120, width:300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Watch YouTube',
					html: 'You can also watch YouTube in sync',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#player', x: 100, y: 120, width:300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Search for a new video',
					html: 'Search for a video and load it for you and your partner',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#search_value', x: 40, y: 0, width:300, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				// {
				// 	title: 'IRC Chat [optional]',
				// 	html: 'This is a web IRC client that connects to a channel called ##simulchat. Here you can find your partner if they are online and send them your ID. It is advised to send a private message, since anyone can see what you time in the defualt channel. Just pick a Nickname and click start. Note that you do not need to use this chat box. It is just there to help you exchange your ID\'s. You can also send your ID to your partner in any way you please, like email',
				// 	buttons: { Prev: -1, Next: 1 },
				// 	focus: 1,
				// 	position: { container: '#kiwi_irc_frame', x: 200, y: 120, width: 400, arrow: 'tm' },
				// 	submit: tourSubmitFunc
				// },
				{
				title: 'Done',
				html: 'Thank you for finishing the tour. This site was made so that people can connect to each other in an easy way. It is still under construction, so watch this space',
				buttons: { Done: 2 },
				focus: 0,
				position: { container: '#my_id', x: -150, y: 20, width: 300, arrow: '' },
				submit: tourSubmitFunc
			}
			];
			$.prompt(tourStates);	
	    }
		(function localFileVideoPlayerInit(win) {
	    var URL = win.URL || win.webkitURL,
	        displayMessage = (function displayMessageInit() {
	            var node = document.querySelector('#message');

	            return function displayMessage(message, isError) {
	                node.innerHTML = message;
	                node.className = isError ? 'error' : 'info';
	            };
	        }()),
	        playSelectedFile = function playSelectedFileInit(event) {
	            file = this.files[0];

	            var type = file.type;

	            videoNode = document.querySelector('#my_video');

	            var canPlay = videoNode.canPlayType(type);

	            canPlay = (canPlay === '' ? 'no' : canPlay);

	            var message = 'Can play type "' + type + '": ' + canPlay;

	            var isError = canPlay === 'no';

	            //displayMessage(message, isError);

	            if (isError) {
	                return;
	            }

	            var fileURL = URL.createObjectURL(file);

	            videoNode.src = fileURL;
	            console.log(videoNode.readyState);
	            console.log(file.name);
	            console.log(file.size);

	            //$("#stat_my_video").text(file.name);
	            //$("#stat_my_size").text(file.size);
	            stat_my_video = insert_spaces(file.name,8);
	            stat_my_size = file.size;
	            sendStatus();
	            updateMyStatus();
				videoNode.onpause = function() {
				   	console.log("Paused " + videoNode.currentTime);
	            	my_send('{"action_change":"paused", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');

				};
				videoNode.onseeked = function() {
				    console.log("Seeked " + videoNode.currentTime);
				    if(Math.abs(videoNode.currentTime - last_received_time) > 1){ //do this so that a infinite loop does not happen (hopefully)
				   		my_send('{"action_change":"seek", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
					}
				};
				videoNode.onplaying = function() {
				    console.log("Playing " + videoNode.currentTime);
				    //my_send('{"action":"status", "time":"'+videoNode.currentTime+'"}');
				    my_send('{"action_change":"play", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
				};
	        },
	        inputNode = document.querySelector('#video_file');
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
	    inputNode.addEventListener('change', playSelectedFile, false);
	}(window));
	//YOUTUBE CODE
		var my_timer;
     
      	function load_video_by_id(vid_id){
      	  	player.loadVideoById(vid_id);
          	player.seekTo(0);
          	clearInterval(title_timeout);
		    clearInterval(yt_ready_timeout);
          	yt_me_ready = false;
			yt_partner_ready = false;
			if(conn != null && conn.open == true){
				$("#player_only").css('visibility', 'hidden');
				$("#loading_info").show();
				clearInterval(title_timeout);
	          	title_timeout =  setInterval(function(){
	          		console.log("title: "+player.getVideoData().title);
	          		if(player.getPlayerState() != -1){
	          			$("#youtube_title").text(player.getVideoData().title);
	          			clearInterval(title_timeout);
	          			player.seekTo(0);
	          			player.pauseVideo();
	          			
	          		}
	          		else{
	          			player.seekTo(0);
	          			player.playVideo();
	          		}
	          	}, 1000);
	          	yt_ready_timeout = setInterval(function(){
      				if(yt_me_ready == true && yt_partner_ready == true){
      					clearInterval(yt_ready_timeout);
      					$("#youtube_title").text(player.getVideoData().title);
      					my_send('{"user_action":"youtube", "user_event":"ready"}');
      					console.log('ready');
      					$("#player_only").css('visibility', 'visible');
      					$("#loading_info").hide();
      					player.playVideo();
      				}
      				else if(yt_me_ready == true && yt_partner_ready == false){
      					clearInterval(yt_ready_timeout);
      					$("#youtube_title").text(player.getVideoData().title);
      					my_send('{"user_action":"youtube", "user_event":"ready"}');
      					console.log('ready');
      				}
      				else{
      					if(player.getVideoLoadedFraction()*player.getDuration() > 10){ //amount of seconds loaded
      						yt_me_ready = true;
      					}
      					else{
      						player.playVideo();
      						player.pauseVideo();
      					}
      				}
      			},1000);
	          	get_related(vid_id);
	          	my_send('{"user_action":"youtube", "user_event": "new_video", "new_vid_id": "'+vid_id+'"}');
			}
			else{
				player.playVideo();
				get_related(vid_id);
			}
			
      	}
      	function getQueryVariable(url_string, variable)
      	{
            if(url_string == ''){
              	return(false);
            }
            var query = url_string.split("?");
            var vars = query[1].split("&");
            for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
            }
            //search(url_string);
            return(false);
      	}
      	var tag = document.createElement('script');
      	tag.src = "https://www.youtube.com/iframe_api?autohide=1";
      	var firstScriptTag = document.getElementsByTagName('script')[0];
      	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      	function onYouTubeIframeAPIReady() {
        	player = new YT.Player('player', {
          		height: '390',
          		width: '640',
          		playerVars: { 'autoplay': 0, 'rel':0},
          		videoId: 'n5scparvQWE',
          		events: {
            		'onReady': onPlayerReady,
            		'onStateChange': onPlayerStateChange
         		}
        	});
      	}
      	// 4. The API will call this function when the video player is ready.
      	function onPlayerReady(event) {
        	//event.target.playVideo();
        	console.log("video ready");
     	}
	    // 5. The API calls this function when the player's state changes.
	    //    The function indicates that when playing a video (state=1),
	    //    the player should play for six seconds and then stop.
	    var done = false;
	    function onPlayerStateChange(event) {  
	    	if(yt_me_ready == true){
	    		//last_received_pause = window.performance.now();
	    		if( (window.performance.now() -last_received_pause)>100 || event.data == YT.PlayerState.PLAYING || user_event == YT.PlayerState.PLAYING){
	    			my_send('{"user_action":"youtube", "user_event": "'+event.data+'", "youtube_time": "'+player.getCurrentTime()+'"}');
	    		}
	       		
	    	}
	       	if(event.data == YT.PlayerState.BUFFERING && previous_state == YT.PlayerState.PLAYING){
       		 	clearTimeout(restart_after_buffer);
       		 	restart_after_buffer = setTimeout(function(){ 
       		 		if(yt_ready_timeout == true && yt_partner_ready==true){
	       		 		player.playVideo();
	       		 		console.log("restarted");
       		 		}
       		 	}, 2000);
	       	}
	       	if(event.data == YT.PlayerState.PAUSED && previous_state == YT.PlayerState.BUFFERING){	
       			clearTimeout(restart_after_buffer);
       		}
       		if(event.data == 0){
       			var user = $("#playlist_videos").find('.playlist_item').attr('user-value');
       			if(user == 'Me'){
       				var vid_id = $("#playlist_videos").find('.playlist_item').attr('video-id');
       				load_video_by_id(vid_id);
       				//my_send('{"user_action":"youtube", "user_event": "new_video", "new_vid_id": "'+vid_id+'"}');
       				$("#playlist_videos").find('.playlist_item')[0].remove();
       			}
       			
       			console.log(user);
       		}
	       	previous_state = event.data;
        	console.log(event.data);
      	}
      	function stopVideo() {
        	player.stopVideo();
      	}
     //});
	//END OF YOUTUBE CODE
	//start of youtube search
		var my_response;

		function showResponse(response) {
		    my_response = response;
		}

		function onClientLoad() {
		    gapi.client.load('youtube', 'v3', onYouTubeApiLoad);
		}

		function onYouTubeApiLoad() {
		    gapi.client.setApiKey('AIzaSyCR5In4DZaTP6IEZQ0r1JceuvluJRzQNLE');
		    search('');
		}

		function search(search_query) {
		    // Use the JavaScript client library to create a search.list() API call.
		    //var search_query = $("#query").val();
		    var request = gapi.client.youtube.search.list({
		        part: 'snippet',
		        q: search_query,
		        //relatedToVideoId: '09R8_2nJtjg',
		        //type: 'video'
		        maxResults: 25
		    });
		    request.execute(onSearchResponse);
		}
		function get_related(video_id){
			$("#related_videos").empty();
			var request = gapi.client.youtube.search.list({
		        part: 'snippet',
		        relatedToVideoId: video_id,
		        maxResults: 25,
		        type: 'video'
		    });
		    request.execute(onRelatedResponse);
		}
		function strip(html){
		   var tmp = document.createElement("DIV");
		   tmp.innerHTML = html;
		   return tmp.textContent || tmp.innerText || "";
		}
		function connect_click(){
			$("#connect").hide();
	    	console.log($("#connect_id").val());
	    	conn = peer.connect($("#connect_id").val().trim(),{metadata:"connection"});
	    	my_connect(conn);
	    	data_conn = peer.connect($("#connect_id").val().trim(), {metadata:"data", reliable:true});
		   	my_connect(data_conn);
	    }

	    function add_to_playlist(video_id, title, user){
	    	if($("#playlist_videos").find('.playlist_'+video_id).length == 0)
	    	{
				$("#playlist_videos").append('<div class="container-fluid"><div class="row playlist_item playlist_'+video_id+'" user-value="'+user+'" video-id="'+video_id+'"><a href="#" class="playlist_item_clicked" video-id="'+video_id+'" ><div class="col-md-6"><img src="https://i.ytimg.com/vi/'+video_id+'/default.jpg"></div><div class="col-md-6"><h6>'+ title +'</h6></div>Added by: '+user+'</a></div></div>');
				
				//var user = user;
				if(user=='Me'){
					 my_send('{"user_action":"youtube", "user_event": "load_playlist", "video_id": "'+video_id+'", "video_title":"'+title+'"}');
				}
			}
		}
		function remove_from_playlist(video_id){
			$("#playlist_videos").find('.playlist_'+video_id).remove();
		}
	    /////////////////////////////////////////////////
	    // DOCUMENT READY	
	    /////////////////////////////////////////////////
		$(document).ready(function(){

			//paperjs
				

		       

		       

			ion.sound({
			    sounds: [
			        {
			            name: "message_drop"
			        }
			    ],
			    volume: 0.6,
			    path: "sounds/",
			    preload: true
			});
			// video_size();
	  // 		movie_size();
			$("#voice").hide();
			$("#disconnect_div").hide();
			$("#end_voice_call").hide();
			$("#hang_up").hide();
			$("#end_video_call").hide();
			$("#hang_up_video").hide();
			var video_width = $("#video_div").width();
			var video_height = Math.round(video_width * 9 / 16);
			//var previous_partner_seektime = 0;
			$("#my_video").width(video_width);
			$("#my_video").height(video_height);
			$("#typing_msg").hide();
			$("#loading_info").hide();
			$("#online_people").hide();
			$("#public_chat_area").hide();
			$("#progress").hide();
			$("#progress_sent").hide();
			$("#the_player").hover(function(){
	       		// $("#the_player").css("background-color", "yellow");
	       		//console.log("inside");
	        	time = player.getCurrentTime();
	        	clearInterval(my_timer);
	         	my_timer = setInterval(function () {
	            	var cur_time = player.getCurrentTime();
					if (Math.abs(time-cur_time) > 1) {
		                console.log("seeked from "+ time + " to " + cur_time);
		                my_send('{"user_action":"youtube", "user_event": "seeked", "youtube_time": "'+player.getCurrentTime()+'"}');
	            	}
	           		time = cur_time;
	        	}, 100);
	        },function(){
	        // $("#the_player").css("background-color", "pink");
		        //console.log("outside");
		        clearInterval(my_timer);
	   		});

			$(window).focus(function() {
				var tab_message = (unread_messages == 1) ? 'message':'messages';
				document.title = original_title;
				unread_messages = 0;
			    window_focus = true;
			}).blur(function() {
			    window_focus = false;
			});

			// $('#public_name').keyup(function(e){
			//     if(e.keyCode == 13)
			//     {
			//         $(this).trigger("joinchat");
			//     }
			// });	
			// $('#public_name').bind("joinchat",function(e){
			// 	join_chat();
			// });
			// function join_chat(){
			// 	var pub_name = $("#public_name").val();
			// 	if(pub_name.length > 0){
			// 		$("#public_chat_error").empty();
			// 		$("#public_message").focus();
			// 		$("#join_public_chat").hide();
			// 		$("#online_people").show();
			// 		//$("#online_people_list").append('<li class="list-group-item">'+pub_name+'</li>');
			// 		$("#public_chat_area").show();
				
			// 		socket =  io.connect('chat.simulchat.com:3000',{'forceNew':true });
			// 		socket.on('connect', function(err){
			// 			socket.emit('set_name', pub_name);
			// 			socket.emit('create', 'Lobby');
			// 			console.log("connected");
			// 			socket.on('chat message', function(msg){
			// 		    	var d= new Date();
			// 				var msg_time = d.toLocaleTimeString();
			// 				var new_message = '<div class="shout_msg"><time>'+msg_time+'</time><span class="message">'+strip(msg)+'</span></div>';
			// 		   		$(new_message).linkify().hide().appendTo('#public_chat_text').fadeIn();
			// 		   		var scrolltoh = $('#public_chat_text')[0].scrollHeight;
			// 				$('#public_chat_text').scrollTop(scrolltoh);
			// 		    });
			// 		    socket.on('in_room', function(in_room){

			// 		    	$("#online_people_list").empty();
			// 		    	for(var i=0;i<in_room.length; i++){
			// 		    		console.log(in_room);
			// 		    		$("#online_people_list").append('<li class="list-group-item" id="'+in_room[i].id+'">'+in_room[i].name+'</li>');
			// 		    	}
			// 		    });
			// 		    socket.on('new_user', function(new_user){
			// 		    	console.log(new_user);
			// 		    	$("#online_people_list").append('<li class="list-group-item" id="'+new_user.id+'">'+new_user.name+'</li>');
			// 		    });
			// 		    socket.on('user_dc', function(user_dc){
			// 		    	console.log(user_dc);
			// 		    	$("#"+user_dc.id).remove();
			// 		    });
			// 		    socket.on('disconnect', function(){
			// 		    	$("#join_public_chat").show();
			// 				$("#online_people").hide();
			// 				$("#public_chat_area").hide();
			// 				$("#online_people_list").empty();
			// 				$("#public_chat_error").append("Disconnected from chat<br>");
			// 		    });
			// 		    socket.on('new_name', function(new_name){
			// 		    	console.log(new_name);
			// 		    });
			// 		    socket.on('name_taken', function(){
			// 		    	$("#public_chat_error").html("Name already taken<br>");
			// 		    	console.log("name taken");
			// 		    });
			// 		    socket.on('reconnect', function(){
			// 		    	socket.disconnect();
			// 		    });
			// 	    });
			// 	}
			// 	else{
			// 		$("#public_chat_error").text("Name must not be blank");
			// 	}
			// }
			// $("#join_chat").click(function(e){
			// 	e.preventDefault();
			// 	join_chat();
			// 	//console.log($("#public_name").val());
			// });
			// $("#leave_chat").click(function(e){
			// 	e.preventDefault();
			// 	$("#join_public_chat").show();
			// 	$("#online_people").hide();
			// 	$("#public_chat_area").hide();
			// 	$("#online_people_list").empty();
			// 	socket.disconnect();
			// 	//console.log($("#public_name").val());
			// });
			// $("#public_message").keypress(function(evt){
			// 	//e.preventDefault();
			// 	if(evt.which == 13) {
			// 		var d= new Date();
			// 		var msg_time = d.toLocaleTimeString();
			// 		var imessage = strip($("#public_message").val());
			// 		//imessage = imessage.replace(regex, "<a href='$1' target='_blank'>$1</a>");
			// 		var data = '<div class="shout_msg me_shout_msg"><time>'+msg_time+'</time><span class="username my_username">You</span><span class="message">'+imessage+'</span></div>';
					
			// 		//append data into messagebox with jQuery fade effect!
			// 		$(data).linkify().hide().appendTo('#public_chat_text').fadeIn();
			// 		socket.emit('chat message', imessage);
			// 		var scrolltoh = $('#public_chat_text')[0].scrollHeight;
			// 		$('#public_chat_text').scrollTop(scrolltoh);
			// 		$("#public_message").val('');
			// 	}
			// });
			$("#slider").change(function(){
				console.log($("#slider").val()/100);
				change_volume($("#slider").val()/100);

			});

			$("#fullscreen_call").click(function(e){
				e.preventDefault();
				launchIntoFullscreen(document.getElementById("call_section"));
				fullscreen_window = 'call';

			});
			$("#fullscreen_movie").click(function(e){
				e.preventDefault();
				launchIntoFullscreen(document.getElementById("section3"));
				fullscreen_window = 'movie';

			});
			$("#contact").click(function(e){
				e.preventDefault();
				if(my_prompt != null){
      				my_prompt.close();
      			}
      			my_prompt = new Impromptu("Please feel free to email simulchat" + "@" +"gmail"+"."+"com for any questions or feedback.", {
					title: "Contact SimulChat",
					buttons: { "OK": true}
				});

			});

			$("#load_vid").click(function(e){
		      	e.preventDefault();
		        var vid_id = getQueryVariable($("#youtube_link").val(), 'v');
		        if(vid_id){
		          	$("#youtube_link").val('');
		          	load_video_by_id(vid_id);
		        }
		        console.log(vid_id);
	      	});
	      	$("#server_button").click(function(e){
	      		e.preventDefault();
	      		if(peer.open == false){
	      			peer.reconnect();
	      		}
	      	});
			$("#floating_video").hide();

			$("#connect").click(function(e){
		    	e.preventDefault();
		    	connect_click();
		    });
		    
		    $("#disconnect").click(function(e){
		    	e.preventDefault();
		    	conn.close();
		    });
		    $("#voice_call").click(function(e){
		    	e.preventDefault();
		    	if(call != null){
		    		call.close();
		    	}
		    	if(window.localStream != null && window.localStream.getAudioTracks().length > 0)
		    	{
		    		$("#voice_call").hide();
		    		$("#hang_up").show();
		    		if(window.localStream.getVideoTracks().length > 0){
		    			window.localStream.getVideoTracks()[0].enabled = false;
		    		}
			    	call = peer.call(conn.peer, window.localStream, {metadata:'voice'});
			    	call.on('stream', function(stream){
			    		window.remoteStream = stream;
				      	change_status_button("call_button","green");
			    		$("#hang_up").hide();
				        $('audio').prop('src', URL.createObjectURL(stream));
				        $("#end_voice_call").show();
				        $("#voice_call").hide();
				    });
				    call.on('close', function(){
				      	change_status_button("call_button","red");
				  	  	$("#end_voice_call").hide();
					    $("#voice_call").show();
					    $("#hang_up").hide();
			  	 	});
				}
				else{
					get_mic();
					if(my_prompt != null){
		      			my_prompt.close();
		      		}
		      		my_prompt = new Impromptu("Your browser is asking you to activate your microphone. The popup should be somewhere on the top or bottom of your screen", {
						title: "Activate Your Microphone and try again.",
						buttons: { "OK": true}
					});
				}
		    });
			$("#video_call").click(function(e){
		    	e.preventDefault();
		    	if(call != null){
		    		call.close();
		    	}
		    	if(window.localStream != null && window.localStream.getVideoTracks().length > 0)
		    	{
		    		$("#video_call").hide();
		    		$("#hang_up_video").show();
		    		if(window.localStream.getVideoTracks().length > 0){
		    			window.localStream.getVideoTracks()[0].enabled = true;
		    		}
			    	call = peer.call(conn.peer, window.localStream, {metadata:'video'});
			    	call.on('stream', function(stream){
			    		window.remoteStream = stream;
				      	change_status_button("video_call_button","green");
			    		$("#hang_up_video").hide();
				        $('#their-video').prop('src', URL.createObjectURL(stream));
				        $('#their-video-smaller').prop('src', URL.createObjectURL(stream));
				        $("#end_video_call").show();
				        //$("#voice_call").hide();
				    });
				    call.on('close', function(){
				      	change_status_button("video_call_button","red");
				  	  	$("#end_video_call").hide();
					    $("#video_call").show();
					    $("#hang_up_video").hide();
					    exitFullscreen();
			  	 	});
				}
				else{
					get_cam();
					if(my_prompt != null){
		      			my_prompt.close();
		      		}
		      		my_prompt = new Impromptu("Your browser is asking you to activate your camera. The popup should be somewhere on the top or bottom of your screen", {
						title: "Activate Your Camera and try again.",
						buttons: { "OK": true}
					});
				}
		    });
		    $("#hang_up").click(function(e){
		    	e.preventDefault();
		    	$("#hang_up").hide();
		    	$("#voice_call").show();
		    	my_send('{"call_status": "hang_up"}');
		    });
		    $("#hang_up_video").click(function(e){
		    	e.preventDefault();
		    	$("#hang_up_video").hide();
		    	$("#video_call").show();
		    	my_send('{"call_status": "hang_up_video"}');
		    });
		    $("#end_voice_call").click(function(e){
		    	e.preventDefault();
		    	if(call){
		    		call.close();
		    	}
		    	my_send('{"call_status": "hang_up"}');
		    });
		    $("#end_video_call").click(function(e){
		    	e.preventDefault();
		    	if(call){
		    		call.close();
		    	}
		    	my_send('{"call_status": "hang_up_video"}');
		    });
		    $("#take_tour").click(function(e){
		    	e.preventDefault();
		    	ga('send', 'event', 'Clicks', 'Tour');
		    	takeTour();
		    });
			$("#call_section").hover(function(){
				$("#floating_video").hide();
			},function(){
				if(call != null && call.open == true && call.metadata == "video"){
					$("#floating_video").show();
				}
			});
			$("#clear_paper").click(function(e){
				e.preventDefault();
				my_clear();
				my_send('{"clear_paper":"true"}');
			});
			$("#save_paper").click(function(e){
				e.preventDefault();
				save_img();
			});
			$(".header").click(function (e) {
				//get CSS display state of .toggle_chat element
				var toggleState = $('.toggle_chat').css('display');
				
				//toggle show/hide chat box
				$('.toggle_chat').slideToggle();
				
				//use toggleState var to change close/open icon image
				if(toggleState == 'block')
				{
					$(".header div").attr('class', 'open_btn');

				}else{
					$(".header div").attr('class', 'close_btn');
					$("#shout_message").focus();
				}
				var scrolltoh = $('.message_box')[0].scrollHeight;
				$('.message_box').scrollTop(scrolltoh);
				unread_messages = 0;
				update_badge();
			});
			$("#shout_message").keypress(function(evt) {
				if(evt.which == 13) {
					var iusername = $('#shout_username').val();
					var imessage = strip($('#shout_message').val());
					
					var to_send = {textMessage:"true", name:encodeURIComponent(iusername), message:encodeURIComponent(imessage)};
					console.log(to_send);
					var to_send = JSON.stringify(to_send);
					console.log(to_send);
					$('.alert_shout_msg').remove();
					var d= new Date();
					var msg_time = d.toLocaleTimeString();
					if(conn != null && conn.open == true){
						if(imessage.length > 0){
							my_send(to_send);
							last_typed_time = 0;
							//imessage = imessage.replace(regex, "<a href='$1' target='_blank'>$1</a>");
							var data;
							if(previous_sender != "me"){
							 data = '<div class="shout_msg me_shout_msg"><time>'+msg_time+'</time><span class="username my_username">You</span><span class="message">'+imessage+'</span></div>';
							 	previous_sender = "me";
							}
							else{
								data = '<div class="shout_msg me_shout_msg"><time>'+msg_time+'</time><span class="message">'+imessage+'</span></div>';
							}
							//append data into messagebox with jQuery fade effect!
							$(data).linkify().hide().appendTo('.message_box').fadeIn();
			
							//keep scrolled to bottom of chat!
							var scrolltoh = $('.message_box')[0].scrollHeight;
							$('.message_box').scrollTop(scrolltoh);
							
							//reset value of message box
							$('#shout_message').val('');
						}
					}
					else{
						//$('.alert_shout_msg').remove();
						var data = '<div class="shout_msg alert_shout_msg"><time>'+msg_time+'</time><span class="username alert_msg">Alert</span><span class="message alert_msg">You are not connected</span></div>';
						//append data into messagebox with jQuery fade effect!
						$(data).hide().appendTo('.message_box').fadeIn();
		
						//keep scrolled to bottom of chat!
						var scrolltoh = $('.message_box')[0].scrollHeight;
						$('.message_box').scrollTop(scrolltoh);
					}
				}
				else{
					if((window.performance.now() - last_typed_time) > 5000){
						my_send('{"typing":"true"}');
						last_typed_time = window.performance.now();
					}
				}
			});
			$("#the_results").on('click', '.a_clicked_result', function(e){
			  	e.preventDefault();
			  	load_video_by_id($(this).attr('video-id'));
			  	my_scroll("#youtube_heading");
			  	console.log("clicked");
			});
			$("#the_results").on('click', '.a_search_result .playlist', function(e){
			  	e.preventDefault();
			  	// load_video_by_id($(this).attr('video-id'));
			  	// my_scroll("#youtube_heading");
			  	console.log("clicked on button "+$(this).attr('video-id') + " "+ $(this).attr('video-title'));
			  	add_to_playlist($(this).attr('video-id'),$(this).attr('video-title'),'Me');
			  	$(this).text('Added to Playlist');
			});
			$("#related_videos").on('click', '.playlist', function(e){
			  	e.preventDefault();
			  	// load_video_by_id($(this).attr('video-id'));
			  	// my_scroll("#youtube_heading");
			  	console.log("clicked on button "+$(this).attr('video-id') + " "+ $(this).attr('video-title'));
			  	add_to_playlist($(this).attr('video-id'),$(this).attr('video-title'),'Me');
			  	$(this).text('Added to Playlist');
			});
			$("#related_videos").on('click', '.a_clicked_result', function(e){
			  	e.preventDefault();
			  	load_video_by_id($(this).attr('video-id'));
			  	my_scroll("#youtube_heading");
			  	console.log("clicked");
			});
			//////
			$("#playlist_videos").on('click', '.playlist_item_clicked', function(e){
			  	e.preventDefault();
			  	load_video_by_id($(this).attr('video-id'));
			  	remove_from_playlist($(this).attr('video-id'));
			  	my_scroll("#youtube_heading");
			  	console.log("clicked");
			});

			////
			$('#search_value').keyup(function(e){
			    if(e.keyCode == 13)
			    {
			        $(this).trigger("searchYoutube");
			    }
			});	
			$('#search_value').bind("searchYoutube",function(e){
				$("#the_results").scrollTop(0);
				$('#the_results').empty();
			  	search($("#search_value").val());
			  	my_scroll("#results_heading");
			});
			$('#youtube_link').keyup(function(e){
			    if(e.keyCode == 13)
			    {
			        $(this).trigger("loadURL");
			    }
			});	
			$('#youtube_link').bind("loadURL",function(e){
			  	//search($("#search_value").val());
			  	var vid_id = getQueryVariable($("#youtube_link").val(), 'v');
		        if(vid_id){
		          	$("#youtube_link").val('');
		          	load_video_by_id(vid_id);
		        }
			});
			$('#connect_id').keyup(function(e){
			    if(e.keyCode == 13)
			    {
			        $(this).trigger("clickOnConnect");
			    }
			});	
			$('#connect_id').bind("clickOnConnect",function(e){
			  	connect_click();
			});

			movie_size();
		});
		
		// Called automatically with the response of the YouTube API request.
		function onSearchResponse(response) {
		    //$('#results').empty();
            //$('#the_results').empty();
            var num_of_videos = 0;
            for(var i = 0; i < response.items.length; i++){
              	if(response.items[i].id.kind == "youtube#video"){
                	//console.log(response.items[i].id.videoId + " " + response.items[i].snippet.title + " " + response.items[i].snippet.thumbnails.default.url);
                	$("#the_results").append('<div class="row a_search_result"><a href="#" class="a_clicked_result" video-id="'+response.items[i].id.videoId+'"><div class="col-md-3"><img src="'+response.items[i].snippet.thumbnails.default.url+'"></div><div class="col-md-9"><h4>'+ response.items[i].snippet.title +'</h4><p>'+response.items[i].snippet.channelTitle+'</p></a><button class="playlist btn btn-xs" video-id="'+response.items[i].id.videoId+'" video-title="'+response.items[i].snippet.title+'" >Playlist</button></div></div>');
                	num_of_videos = num_of_videos+1;
             	}
             	// if(num_of_videos == 5){
             	// 	break;
             	// }
            }
		}
		function onRelatedResponse(response) {
		    //$('#results').empty();
            //$('#the_results').empty();
            var num_of_videos = 0;
            for(var i = 0; i < response.items.length; i++){
              	if(response.items[i].id.kind == "youtube#video"){
                	//console.log(response.items[i].id.videoId + " " + response.items[i].snippet.title + " " + response.items[i].snippet.thumbnails.default.url);
                	$("#related_videos").append('<div class="container-fluid"><div class="row a_search_result" video-id="'+response.items[i].id.videoId+'"><a href="#" class="a_clicked_result" video-id="'+response.items[i].id.videoId+'"><div class="col-md-6"><img src="'+response.items[i].snippet.thumbnails.default.url+'"></div><div class="col-md-6"><h6>'+ response.items[i].snippet.title +'</h6><p>'+response.items[i].snippet.channelTitle+'</p></a><button class="playlist btn btn-xs" video-id="'+response.items[i].id.videoId+'" video-title="'+response.items[i].snippet.title+'" >Playlist</button></div></div></div>');
                	num_of_videos = num_of_videos+1;
             	}
             	if(num_of_videos == 17){
             		break;
             	}
            }
		}
	//end of youtube search
</script>
 <script src="https://apis.google.com/js/client.js?onload=onClientLoad" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60494371-1', 'auto');
  ga('send', 'pageview');
</script>

<script src="//vjs.zencdn.net/4.12/video.js"></script>
<script src="js/jquery-ui.min.js"></script>

<script>
	$(".tool_tip").tooltip();
</script>
<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
</script>
