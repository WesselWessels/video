<!-- code for video credit: http://jsfiddle.net/dsbonev/cCCZ2/-->

<!DOCTYPE html>
<html>
	<head>
		<title>Watch videos together</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<link rel="stylesheet" href="css/bootstrap.css">
		<link href="css/styles.css" rel="stylesheet">
		<script type="text/javascript" src="js/jquery-impromptu.js"></script>
		<link rel="stylesheet" href="css/jquery-impromptu.css">
		<script src="js/bootstrap.js"></script>
		<script src="js/scripts.js"></script>
 		<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>
 		<script type="text/javascript" src="js/jquery.linkify.min.js"></script>
 		<script type="text/javascript" src="js/ion.sound.min.js"></script>
 		<link href="//vjs.zencdn.net/4.12/video-js.css" rel="stylesheet">
		<style type="text/css">
			video, input {
			    display: block;
			}
			input {
			    width: 100%;       
			}
			.info {
			    background-color: aqua;            
			}

			.error {
			    background-color: red;
			    color: white;
			}
			.a_search_result{
            	padding-bottom: 5px;
          	}
          	.link_button{
          		color:black;
         	}
          	#my-video-div{
          		vertical-align: bottom;
          	}
          	#my-video{
			    transform: rotateY(180deg);
			    -webkit-transform:rotateY(180deg); /* Safari and Chrome */
			    -moz-transform:rotateY(180deg); /* Firefox */
			}
			.shout_box {
				background:#1B9CE0; width:260px; overflow:hidden;
				position:fixed; bottom:0; right:10%; z-index:9;
			}
			.shout_box .header .close_btn {
				background: url(img/close_btn.png) no-repeat 0px 0px; 
				float:right; width:15px;
				height: 15px;
			}
			.shout_box .header .close_btn:hover {
				background: url(img/close_btn.png) no-repeat 0px -16px;
			}
			.shout_box .header .open_btn {
				background: url(img/close_btn.png) no-repeat 0px -32px;
				float:right; width:15px;
				height:15px;
			}
			.shout_box .header .open_btn:hover {
				background: url(img/close_btn.png) no-repeat 0px -48px;
			}
			.shout_box .header{
				padding: 10px 6px 6px 10px;
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif;
				font-weight: bold; color:#fff;
				border: 1px solid rgba(0, 39, 121, .76);
				border-bottom:none; cursor:pointer;
			}
			.shout_box .header:hover{
				background-color: #168ccc;
			}
			.shout_box .message_box {
				background: #FFFFFF; height: 200px;
				overflow:auto; border: 1px solid #CCC;
			}
			.shout_msg{
				margin-bottom: 2px; display: block;
				border-bottom: 1px solid #F3F3F3; padding: 0px 5px 5px 5px;
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif; color:#7C7C7C;
			}
			.me_shout_msg{
				color:#5CB85C;
			}
			.alert_shout_msg{
				color:#DB524B;
			}
			.message_box:last-child { 
				border-bottom:none;
			}
			time{ 
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif;
				font-weight: normal; float:right; color: #D5D5D5;
			}
			.shout_msg .username{
				margin-bottom: 3px;margin-top: 3px;
			}
			.shout_msg .my_username{
				color:#5CB85C;
			}
			.shout_msg .alert_msg{
				color:#DB524B;
			}
			.user_info input {
				width: 98%; height: 25px; border: 1px solid #CCC; border-top: none; padding: 3px 0px 0px 3px;
				font: 11px 'lucida grande', tahoma, verdana, arial, sans-serif;
			}
			.shout_msg .username{
				font-weight: bold; display: block;
			}
			#floating_video{
				position: fixed;
				top: 70px; 
				left: 30px; 
				width: 180; 
				height: 120;
			}
			.youtube_history{
			    margin: 0;
			    padding: 0;
			    height: 390px;
			    width: 100%;
			    display: block; 
			    /* border:solid #000 1px */
			}
			.content_bla{
			    padding:0;
			    overflow: scroll; 
			    overflow-x:hidden;
			    height:100%
			    /*-webkit-overflow-scrolling: touch;*/    
			}
			.related_box{
			    margin: 0;
			    padding: 0;
			    height: 390px;
			    width: 100%;
			    display: block; 
			    /* border:solid #000 1px */
			}
			.related_items{
			    padding:0;
			    overflow: scroll; 
			    overflow-x:hidden;
			    height:100%
			    /*-webkit-overflow-scrolling: touch;*/    
			}
			.results_box{
			    margin: 0;
			    padding: 0;
			    height: 390px;
			    width: 100%;
			    display: block; 
			    /* border:solid #000 1px */
			}
			#the_results{
			    padding:0;
			    overflow: scroll; 
			    overflow-x:hidden;
			    height:100%
			    /*-webkit-overflow-scrolling: touch;*/    
			}
			.typing_msg{
				padding-left: 3em;
				font-style: italic;
			}
		</style>
	</head>

	<body>
		<nav class="navbar navbar-trans navbar-fixed-top" role="navigation">
		  	<div class="container">
			    <!-- Brand and toggle get grouped for better mobile display -->
			    <div class="navbar-header">
			      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
			        <span class="sr-only">Toggle navigation</span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			      </button>
			      <a class="navbar-brand" href="#section1">simulchat.com</a>
			    </div>
			    <!-- Collect the nav links, forms, and other content for toggling -->
			    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				    <ul class="nav navbar-nav">
				        <li ><a href="#section2">Connect<span class="sr-only">(current)</span></a></li>
				        <li ><a href="#call_section">Talk<span class="sr-only">(current)</span></a></li>
				        <li ><a href="#section3">Watch Video<span class="sr-only">(current)</span></a></li>
				        <li ><a href="#section4">Watch YouTube<span class="sr-only">(current)</span></a></li>
				        <!-- <li ><a href="#section5">IRC Chat<span class="sr-only">(current)</span></a></li> -->
				    </ul>
					<div class="nav navbar-nav navbar-right">
						<a href="#section2"><button type="button" id="server_button" class="btn btn-danger navbar-btn" title="Connection with server"><span class="glyphicon glyphicon-globe" aria-hidden="true"></span></button></a>
			      		<a href="#section2"><button type="button" id="user_button" class="btn btn-danger navbar-btn" title="Connection with partner"><span class="glyphicon glyphicon-user" aria-hidden="true"></span></button></a>
			      		<a href="#call_section"><button type="button" id="call_button" class="btn btn-danger navbar-btn" title="Voice call"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span></button></a>
			      		<a href="#call_section"><button type="button" id="video_call_button" class="btn btn-danger navbar-btn" title="Video call"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span></button></a>
			    	</div>
			    </div><!-- /.navbar-collapse -->
		  	</div><!-- /.container-fluid -->
		</nav>
		<div id="floating_video">
			<video id="their-video-smaller" width="180" height="120" autoplay></video>
		</div>
		<section class="container-fluid" id="section1">
		<div class="container">
			<div style="text-align:center;">			
				<h1 id="page_title">Welcome to SimulChat</h1>
			</div>
			<div class="row" style="text-align:center;">
				<div class="col-md-3"></div>
				<div class="col-md-6">
					<h4>Watch videos together</h4>
					<h4>Watch YouTube together</h4>
					<h4>Talk to each other</h4>
				</div>
				<div class="col-md-3"></div>
			</div>
		</div>
		<div style="text-align:center;">
			<button class="btn btn-success btn-lg" id="take_tour"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>Take Tour</button>
			<a href="#section2" class="btn btn-success btn-lg">Get Started</a>
		</div>
		</section>
		<section class="container-fluid" id="section2">
		<div style="text-align:center;">			
			<h1>Connect to Partner</h1>
		</div>	
		<br><br>
		<div class="container-fluid" id="connection_div">
			<div class="row">
				<div class="col-md-4"></div>
				<div class="col-md-4">
					<div class="form-horizontal">
						<div class="form-group">
						    <label for="my_id" class="col-md-4 control-label">Your ID is: </label>
						    <div class="col-md-8">
						   		<input type="text" class="form-control" id="my_id" readonly>
						   	</div>
					 	</div>
					 	<div class="form-group">
						    <label for="my_id" class="col-md-4 control-label">Partner ID: </label>
						    <div class="col-md-8">
							    <input type="text" class="form-control" id="connect_id" autocomplete="off">
							    <a href="#" class="btn btn-success" id="connect">connect</a>
							    <span id="disconnect_div">
				        		<a href="#" class="btn btn-danger" id="disconnect">disconnect</a>			        		
				        		</span>
						    </div>
					 	</div>	
					</div>
				</div>
				<div class="col-md-4"></div>
			</div>
		</div>	
		<div style="text-align:center;">			
			<h1>No sign-up needed</h1>
			<div class="container">
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<div>No login, no password and no email.</div>
						<div>Simply send your ID to your partner, </div>
						<div>or enter your partner's ID and click connect.</div>
					</div>
					<div class="col-md-4"></div>
					
				</div>
			</div>
		</div>	
        </section>
        <section class="container-fluid" id="call_section">
         	<div style="text-align:center;">			
			<h1 id="talk_heading">Talk to each other</h1>
			<div class="container">
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<a href="#" class="btn btn-success" id="voice_call"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> voice call</a>
				        <a href="#" class="btn btn-info" id="hang_up"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> cancel call</a>
				        <a href="#" class="btn btn-warning" id="end_voice_call"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> end voice</a>
				        <a href="#" class="btn btn-success" id="video_call"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span> video call</a>
				        <a href="#" class="btn btn-info" id="hang_up_video"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span> cancel video call</a>
				        <a href="#" class="btn btn-warning" id="end_video_call"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span> end video call</a>
					</div>
					<div class="col-md-4"></div>
				</div>
			</div>
			<div class="container">
				<div class="row">
					<div class="col-md-8">
						<video id="their-video" width="720" height="480" autoplay></video>
					</div>
					<div class="col-md-4" id="my-video-div">
						<video id="my-video" muted="true" width="180" height="120" autoplay></video>
						
					</div>
				</div>
			</div>
		</div>	
        </section>
        
        <section class="container-fluid" id="section3">
        <div style="text-align:center;">			
			<h1>Watch Videos Together</h1>
		</div>	
		<br><br>
        <div class="container">
        	<div class="col-md-3">
        		<table class="table table-bordered" id="my_status_table">
        			<thead>
        				<th colspan="100%" style="text-align:center;">My Status</th>
        			</thead>
        			<tbody style="text-align:center;">
        				<tr>
        					<td>ID</td>
        					<td id="stat_my_id"></td>
        				</tr>
        				<tr>
        					<td>Microphone</td>
        					<td id="stat_my_mic">Inactive</td>
        				</tr>
        				<tr>
        					<td>Title</td>
        					<td id="stat_my_video"></td>
        				</tr>
        				<tr>
        					<td>Size</td>
        					<td id="stat_my_size"></td>
        				</tr>
        			</tbody>
        		</table>
        	</div>
	        <div id="video_div" class="col-md-6">
				<input type="file" accept="video/mp4,video/webm,video/ogg,audio/*" id="video_file"/>
				<video class="video-js vjs-default-skin" id="my_video" width="720" height="480" controls >
				</video>
			</div>	
        	<div class="col-md-3">
        		<table class="table table-bordered" id="partner_status_table" style="word-wrap:break-word;">
        			<thead>
        				<th colspan="100%" style="text-align:center;">Partner Status</th>
        			</thead>
        			<tbody style="text-align:center;">
        				<tr>
        					<td>ID</td>
        					<td id="stat_partner_id"></td>
        				</tr>
        				<tr>
        					<td>Microphone</td>
        					<td id="stat_partner_mic"></td>
        				</tr>
        				<tr>
        					<td>Title</td>
        					<td id="stat_partner_video"></td>
        				</tr>
        				<tr>
        					<td>Size</td>
        					<td id="stat_partner_size"></td>
        				</tr>
        			</tbody>
        		</table>
        	</div>
		</div>
		<div style="text-align:center;">			
			<h1>Please note</h1>
			<div class="container">
				<div class="row">
					<div class="col-md-4"></div>
					<div class="col-md-4">
						<div>Your video is NOT streamed to your partner.</div>
						<div>Both people need to open</div>
						<div>a video from their own computer.</div>
					</div>
					<div class="col-md-4"></div>	
				</div>
			</div>
		</div>	
		</section>
		<section class="container-fluid" id="section4">
		<div style="text-align:center;">			
			<h1 id="youtube_heading">Watch YouTube Together</h1>
		</div>	
		<div class="container-fluid" >
	      <div class="row">
	        <div class="col-md-3" style="margin:0;padding:0;">
	        	<div class="youtube_history">
	        		<div class="content_bla">

	        		</div>

	        	</div>
	        </div>

	        <div id="the_player" class="col-md-6">
	          	<div id="player"></div>
	          	<h3 id="youtube_title"></h3>
	        </div>
	        <div class="col-md-3">
	        	<h3>Related Videos</h3>
	        	<div class="related_box">
	        		<div id="related_videos" class="related_items">
	        		</div>
	        	</div>
	        </div>
	      </div>
	    </div>
	   <!--  <div style="text-align:center;">			
			<h2>Load new YouTube video</h2>
		</div>	 -->
		<!-- <div class="container">
			<div class="row" style="text-align:center;">
				<div class="col-md-4"></div>
				<div class="col-md-4">
					<div>This will load the video for you and your partner</div>
				</div>
				<div class="col-md-4"></div>
			</div>
		</div> -->
	    <div class="container">
	      	<div class="form-horizontal">
	      		<div class="form-group">
				    <label for="youtube_link" class="col-md-4 control-label"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search YouTube: </label>
				    <div class="col-md-4 input-group">
				   		<input type="text" placeholder="search YouTube" id="search_value" class="form-control">
				   		<!-- <button class="btn btn-success" id="search_button">load</button> -->
				   	</div>   
			 	</div>
				<div class="form-group">
				    <label for="youtube_link" class="col-md-4 control-label"><span class="glyphicon glyphicon-bookmark" aria-hidden="true"></span>  Enter link: </label>
				    <div class="col-md-4 input-group">
				   		<input type="text" placeholder="enter YouTube link" id="youtube_link" class="form-control">
				   		<!-- <a href="#" class="btn btn-success" id="load_vid">load</a> -->
				   	</div>
			 	</div>
		  	</div>
	    </div>
	    <div id="search_result">
          	<div class="row">
            	<div class="col-md-3"></div>
	            <div class="col-md-6">
	              	<div style="text-align:center;">
	                	<h1 id="results_heading">Search Results</h1>
	              	</div>
	              	<div class="results_box">
	              		<div id="the_results"></div>
	              	</div>
	            </div>
            	<div class="col-md-3"></div>
          	</div> 
        </div>  
		<div id="voice">
			<audio controls autoplay></audio>
		</div>
		</section>
		<!-- <section class="container-fluid" id="section5">
		<div style="text-align:center;">			
			<h1>Find Partner and exchange ID's</h1>
		</div>	
		<br>
		<div id="irc_chat" class="container">
			<div class="row">
				<div class="col-md-2"></div>
				<div class="col-md-8">
					<iframe src="https://kiwiirc.com/client/irc.kiwiirc.com/?&theme=basic##simulchat" style="border:0; width:100%; height:450px;" id="kiwi_irc_frame"></iframe>
				</div>
				<div class="col-md-2"></div>
			</div>
		</div>
		<br><br>
		</section> -->
		<!-- shoutbox -->
			<!-- CREDIT: http://www.sanwebe.com/2013/04/creating-shout-box-facebook-style -->
			<div class="shout_box">
				<div class="header">Text Chat <span class="badge" id="unread_badge"></span><div class="close_btn">&nbsp;</div></div>
			  	<div class="toggle_chat" style="display: none;">
				  	<div class="message_box"></div>
				    <div class="user_info">
				   		<input name="shout_message" id="shout_message" type="text" placeholder="Type Message Here"  /> 
				    </div>
			    </div>
			</div>
			<!-- shoutbox end -->
		<!--End of Tawk.to Script-->
	</body>
</html>

<script type="text/javascript">
		//$(document).ready(function(){
		if(!((navigator.userAgent.indexOf("Chrome") != -1) || (navigator.userAgent.indexOf("Firefox") != -1) || (navigator.userAgent.indexOf("Opera") != -1)))
		{
			alert("This website will only work in Chrome, Firefox and Opera");
			//$('html').empty();
		}
		var videoNode;
		var conn;
		var last_received_time = 0;
		var call;
		var original_title = "Watch videos together";
		//youtube variables
			var player;
     		var time; 
     		var partner_is_buffering = false;
     		var partner_previous_state = -2;
     		var restart_after_buffer;
     		var previous_state;
		//end of youtube variables

		var stat_my_id = "-";
		var stat_my_mic = "-";
		var stat_my_video = "-";
		var stat_my_size = "-";
		var stat_partner_id = "-";
		var stat_partner_mic = "-";
		var stat_partner_video = "-";
		var stat_partner_size = "-";

		var previous_sender = "none";

		var regex = /(https?:\/\/([-\w\.]+)+(:\d+)?(\/([\w\/_\.]*(\?\S+)?)?)?)/ig;

		var unread_messages = 0;
		updateMyStatus();
		updatePartnerStatus();
		
		var file;
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
		function my_send(data){
			if(conn != null && conn.open == true){
				conn.send(data);
				console.log("Sent: "+ data);
			}
		}
		function my_scroll(id){
		   var target = $(id);
		    //console.log(this.hash);
		    target = target.length ? target : $('[name=' + id.slice(1) +']');
		    //console.log(target);
		    if (target.length) {
		      $('html,body').animate({
		        scrollTop: target.offset().top - 50
		      }, 750);
		      return false;
		    }
		}

		function get_mic(){
			navigator.getUserMedia({audio: true, video: false}, function(stream){
	        	window.localStream = stream;
	        	//$("#stat_my_mic").text("Active");
	        	stat_my_mic = "active";
	        	sendStatus();
	        	updateMyStatus();
	      	},function(){
	      		console.log("Microphone not granted");
	      	});
		}
		function get_cam(){
			navigator.getUserMedia({audio: true, video: true}, function(stream){
	        	window.localStream = stream;
	        	$('#my-video').prop('src', URL.createObjectURL(stream));
	        	
	        	//$("#stat_my_mic").text("Active");
	        	//stat_my_mic = "active";
	        	//sendStatus();
	        	//updateMyStatus();
	      	},function(){
	      		console.log("Video not granted");
	      	});
		}
		function change_status_button(button, set){
			$("#"+button).removeClass("btn-default btn-success btn-danger btn-warning");
			if(set=="red"){
				$("#"+button).addClass("btn-danger");
			}
			else if(set=="green"){
				$("#"+button).addClass("btn-success");
			}
			else if(set=="yellow"){
				$("#"+button).addClass("btn-warning");
			}
			else{
				$("#"+button).addClass("btn-default");
			}
		}
		function update_badge(){
			if(unread_messages == 0 || $(".toggle_chat").css('display') == "block"){
				unread_messages = 0; //unsure if this is needed
				$("#unread_badge").text('');
				document.title = original_title;
			}
			else{
				//unread_messages = unread_messages +1;
				$("#unread_badge").text(unread_messages);
				var tab_message = (unread_messages == 1) ? 'message':'messages';
				document.title = '['+unread_messages+'] '+tab_message+' - SimulChat';
			}
		}
		//get_mic();
		var words = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","s","t","u","v","w","x","z","aardvark","absurd","adrift","adult","ahead","aimless","allow","alone","ammo","ancient","apple","artist","atlas","baboon","backward","banjo","beaming","bedlamp","beehive","beeswax","blackjack","blowtorch","bookshelf","briefcase","button","cement","choking","chopper","classic","cleanup","cobra","concert","adviser","article","cranky","crucial","eating","erase","escape","fracture","freedom","glitter","goggles","goldfish","indoors","indulge","inverse","island","jawbone","keyboard","kiwi","music","newborn","optic","prefer","pupil","puppy","python","rematch","revenge","reward","robust","select","shadow","solo","stairway","standard","stapler","sugar","tiger","tonic","tracker","tunnel","vapor","wallet","the","name","very","and","just","form","much","great","think","you","say","that","help","low","was","line","for","before","turn","cause","with","same","mean","differ","his","move","they","right","boy","old","one","too","have","does","this","tell","from","sentence","set","had","want","hot","air","but","well","some","also","what","play","there","small","end","can","put","out","home","other","read","were","hand","all","port","your","large","when","spell","add","use","even","word","land","how","here","said","must","big","each","high","she","such","which","follow","act","their","why","time","ask","men","will","change","way","went","about","light","many","kind","then","off","them","need","would","house","write","picture","like","try","these","again","her","animal","long","point","make","mother","thing","world","see","near","him","build","two","self","has","earth","look","father","more","head","day","stand","could","own","page","come","should","did","country","found","sound","answer","school","most","grow","number","study","who","still","over","learn","know","plant","water","cover","than","food","call","sun","first","people","thought","may","let","down","keep","side","eye","been","never","now","last","find","door","any","between","new","city","work","tree","part","cross","take","since","get","hard","place","start","made","might","live","story","where","saw","after","far","back","sea","little","draw","only","left","round","late","man","run","year","came","while","show","press","every","close","good","night","real","give","life","our","few","under","stop","open","ten","seem","simple","together","several","next","vowel","white","toward","children","war","begin","lay","got","against","walk","pattern","example","slow","ease","center","paper","love","often","person","always","money","music","serve","those","appear","both","road","mark","map","book","science","letter","rule","until","govern","mile","pull","river","cold","car","notice","feet","voice","care","fall","second","power","group","town","carry","fine","took","certain","rain","fly","eat","unit","room","lead","friend","cry","began","dark","idea","machine","fish","note","mountain","wait","north","plan","once","figure","base","star","hear","box","horse","noun","cut","field","sure","rest","watch","correct","color","able","face","pound","wood","done","main","beauty","enough","drive","plain","stood","girl","contain","usual","front","young","teach","ready","week","above","final","ever","gave","red","green","list","though","quick","feel","develop","talk","sleep","bird","warm","soon","free","body","minute","dog","strong","family","special","direct","mind","pose","behind","leave","clear","song","tail","measure","produce","state","fact","product","street","black","inch","short","lot","numeral","nothing","class","course","wind","stay","question","wheel","happen","full","complete","force","ship","blue","area","object","half","decide","rock","surface","order","deep","fire","moon","south","island","problem","foot","piece","yet","told","busy","knew","test","pass","record","farm","boat","top","common","whole","gold","king","possible","size","plane","heard","age","best","dry","hour","wonder","better","laugh","true.","thousand","during","ago","hundred","ran","check","remember","game","step","shape","early","yes","hold","hot","west","miss","ground","brought","interest","heat","reach","snow","fast","bed","bring","sing","sit","listen","perhaps","fill","table","east","travel","less","language","morning","among"];
	    //alert(words[Math.floor(Math.random()*words.length)]);
	    var random_id = words[Math.floor(Math.random()*words.length)]+"-"+words[Math.floor(Math.random()*words.length)]+"-"+Math.floor(Math.random()*980+10);
    	var peer = new Peer(random_id,{ key: 'yqyt65uodybbuik9', debug: 3, config: {'iceServers': [
	      { url: 'stun:stun.l.google.com:19302' },
				{
					url: 'turn:numb.viagenie.ca',
					credential: 'muazkh',
					username: 'webrtc@live.com'
				},
				{
					url: 'turn:192.158.29.39:3478?transport=udp',
					credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					username: '28224511:1379330808'
				},
				{
					url: 'turn:192.158.29.39:3478?transport=tcp',
					credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					username: '28224511:1379330808'
				} // Pass in optional STUN and TURN server for maximum network compatibility
	    ]}});
	    peer.on('open', function(){
	    	console.log(peer.id);
	    	change_status_button("server_button","green");
	    	$("#my_id").val(peer.id);
	    	stat_my_id = peer.id;
	    	updateMyStatus();
	    	//$("#stat_my_id").text(peer.id);
	    });
	    peer.on('connection',function(conn){	
	    	console.log(conn.peer);
	    	//var the_peer = conn.peer;
	    	$("#connect_id").val(conn.peer);
	    	//$("#connected_id").text("hello");
	    	//alert(conn.peer);
	    	my_connect(conn);	
	    });
	    peer.on('call', function(call_in){
	      	call = call_in;
	      	console.log("Received call");
	      	console.log(call.metadata);
	      	if(call.metadata == "voice"){
		      	if(window.localStream == null || window.localStream.getAudioTracks().length == 0){
		      		get_mic();
		      		my_send('{"call_status": "mic_inactive"}');
		      		$.prompt("There is an incoming voice call from your partner, but your microphone is not activated. Please activate your microphone.", {
						title: "Activate your microphone",
						buttons: { "OK": true}
						//timeout: 20000,
					});
		      	}
		      	else{
		      		$.prompt("There is an incoming voice call from your partner.", {
						title: "Incoming call",
						buttons: { "Answer": true, "Not now": false },
						//timeout: 20000,
						submit: function(e,v,m,f){
							// use e.preventDefault() to prevent closing when needed or return false. 
							// e.preventDefault(); 
							if(v == true){
								if(window.localStream.getVideoTracks().length > 0){
	    							window.localStream.getVideoTracks()[0].enabled = false;
	    						}	
						  		call.answer(window.localStream);
					      		call.on('stream', function(stream){
				    				window.remoteStream = stream;

						      		change_status_button("call_button","green");
						        	$('audio').prop('src', URL.createObjectURL(stream));
						        	$("#end_voice_call").show();
							    	$("#voice_call").hide();
					  	 		});
				  	  			call.on('close', function(){
							      	change_status_button("call_button","red");
							  	  	$("#end_voice_call").hide();
								    $("#voice_call").show();
				  	  			});
							}
							else{
								my_send('{"call_status": "hang_up"}');
							}
							console.log("Value clicked was: "+ v);
						}
					});
		 	 	}
	 		}
	 		if(call.metadata == "video"){
		      	if(window.localStream == null || window.localStream.getVideoTracks().length == 0){
		      		get_cam();
		      		my_send('{"call_status": "cam_inactive"}');
		      		$.prompt("There is an incoming video call from your partner, but your camera is not activated. Please activate your camera.", {
						title: "Activate your Camera",
						buttons: { "OK": true}
						//timeout: 20000,
					});
		      	}
		      	else{
		      		$.prompt("There is an incoming video call from your partner.", {
						title: "Incoming video call",
						buttons: { "Answer": true, "Not now": false },
						//timeout: 20000,
						submit: function(e,v,m,f){
							// use e.preventDefault() to prevent closing when needed or return false. 
							// e.preventDefault(); 
							if(v == true){
								if(window.localStream.getVideoTracks().length > 0){
	    							window.localStream.getVideoTracks()[0].enabled = true;
	    						}
	    						my_scroll("#talk_heading");
						  		call.answer(window.localStream);
					      		call.on('stream', function(stream){
				    				window.remoteStream = stream;

						      		change_status_button("video_call_button","green");
						        	$('#their-video').prop('src', URL.createObjectURL(stream));
						        	$('#their-video-smaller').prop('src', URL.createObjectURL(stream));
						        	$("#end_video_call").show();
							    	$("#video_call").hide();
							    	$("#hang_up_video").hide();
					  	 		});
				  	  			call.on('close', function(){
							      	change_status_button("video_call_button","red");
							  	  	$("#end_video_call").hide();
								    $("#video_call").show();
				  	  			});
							}
							else{
								my_send('{"call_status": "hang_up_video"}');
							}
							console.log("Value clicked was: "+ v);
						}
					});
		 	 	}
	 		}
	    });
		peer.on('disconnected', function(){
			console.log("Disconnected from server");
			change_status_button("server_button","red");
		});
	    function insert_space(str,pos){
	    	var str_length = str.length;
	    	return str.substring(0,pos) + " " + str.substring(pos, str_length);
	    }
	    function insert_spaces(str, chars){
	    	var str_length = str.length;
	    	var number_of_spaces = Math.floor((str_length-1)/chars);
	    	var return_string = "";
	    	for(var i = 0; i <number_of_spaces+1; i++){
	    		return_string = return_string + str.substring(i*chars,(i+1)*chars) + " ";
	    	}
	    	return return_string;
	    }
	    function get_ping(){
	    	
			// var d = new Date();
			// var n = d.getTime(); 
			my_send('{"ping":"'+window.performance.now()+'"}');
	    }
	    function my_connect(connection){
	    	conn = connection;
	    	conn.on('open',function(){
	    		$("#connected_id").text(conn.peer);
	    		stat_partner_id = conn.peer;
	    		updatePartnerStatus();
	    		change_status_button("user_button", "green");
	    		console.log("Connected");
	    		$("#connect").hide();
	    		$("#disconnect_div").show();
	    		
		    	conn.on('data', function(data){
		    		var message_json = jQuery.parseJSON(data);
		    		if(message_json.textMessage == "true"){
		    			var received_message = strip(decodeURIComponent(message_json.message));
		    			
		    			var d= new Date();
						var msg_time = d.toLocaleTimeString();
						var new_message;
						if(previous_sender!="partner"){
						 	new_message = '<div class="shout_msg"><time>'+msg_time+'</time><span class="username">Partner</span><span class="message">'+received_message+'</span></div>';
						 	previous_sender = "partner";
						}
						else{
							new_message = '<div class="shout_msg"><time>'+msg_time+'</time><span class="message">'+received_message+'</span></div>';
						}
						//append data into messagebox with jQuery fade effect!
						$(new_message).linkify().hide().appendTo('.message_box').fadeIn();
		
						//keep scrolled to bottom of chat!
						var scrolltoh = $('.message_box')[0].scrollHeight;
						$('.message_box').scrollTop(scrolltoh);
		    			console.log(received_message);
		    			ion.sound.play("message_drop");
		    			unread_messages = unread_messages +1;
		    			update_badge();
		    		}
		    		if(message_json.ping != null){
		    			my_send('{"pingback":"'+message_json.ping+'"}');
		    		}
		    		if(message_json.pingback != null){
		    // 			var d = new Date();
						// var n = d.getTime(); 
						console.log((window.performance.now()- message_json.pingback)/2 + "ms");
		    		}
		    		if(message_json.call_status == "hang_up"){
		    			if(call){
	   						call.close();
	   					}
		    			$("#hang_up").hide();
		    			$("#voice_call").show();
		    		}
		    		if(message_json.call_status == "hang_up_video"){
		    			if(call){
	   						call.close();
	   					}
		    			$("#hang_up_video").hide();
		    			$("#video_call").show();
		    		}
		    		if(message_json.call_status == "mic_inactive"){
		    			if(call){
	   						call.close();
	   					}
		    			$("#hang_up").hide();
		    			$("#voice_call").show();
		    			$.prompt("Your partner's microphone is not activated. Please try again.", {
							title: "Partner microphone inactive",
							buttons: { "OK": true}
						});
		    		}
		    		if(message_json.call_status == "cam_inactive"){
		    			if(call){
	   						call.close();
	   					}
		    			$("#hang_up_video").hide();
		    			$("#video_call").show();
		    			$.prompt("Your partner's camera is not activated. Please try again.", {
							title: "Partner camera inactive",
							buttons: { "OK": true}
						});
		    		}
		    		if(message_json.action_change == "paused" && !videoNode.paused){
		    			videoNode.currentTime = message_json.time_of_movie;
		    			videoNode.pause();
		    		}
		    		if(message_json.action_change == "play" && videoNode.paused){
		    			//videoNode.currentTime = message_json.time_of_movie;
		    			if(Math.abs(videoNode.currentTime - message_json.time_of_movie) > 1){
		    					videoNode.currentTime = message_json.time_of_movie;
		    			}
		    			videoNode.play();
		    		}
		    		if(message_json.action_change == "seek"){
		    			if(last_received_time != message_json.time_of_movie){
		    				last_received_time = message_json.time_of_movie;
		    				if(Math.abs(videoNode.currentTime - message_json.time_of_movie) > 1){
		    					videoNode.currentTime = message_json.time_of_movie;
		    				}
		    			}
		    		}
		    		if(message_json.stat_mic != null)
		    		{
		    			stat_partner_mic = message_json.stat_mic;
		    		}
		    		if(message_json.stat_video != null)
		    		{
		    			stat_partner_video = message_json.stat_video;
		    		}
		    		if(message_json.stat_size != null)
		    		{
		    			stat_partner_size = message_json.stat_size;
		    		}
		    		if(message_json.user_action =='youtube')
		    		{
		    			var user_event = message_json.user_event;
		    			if(user_event == YT.PlayerState.PAUSED){
		    				if(player.getPlayerState() != YT.PlayerState.PAUSED )
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					player.pauseVideo();
		    				}
		    			}
		    			if(user_event == YT.PlayerState.BUFFERING){
		    				partner_is_buffering = true;
		    				if(player.getPlayerState() != YT.PlayerState.PAUSED)
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					player.pauseVideo();
		    				}
		    			}
		    			if(user_event == YT.PlayerState.PLAYING){
		    				partner_is_buffering = false;
		    				if(player.getPlayerState() != YT.PlayerState.PLAYING)
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					player.playVideo();
		    				}
		    			}	
		    			if(user_event == 'seeked'){
		    				if(Math.abs(player.getCurrentTime() - message_json.youtube_time) > 1)
		    				{
		    					player.seekTo(message_json.youtube_time);
		    					time = message_json.youtube_time;
		    				}
		    			}
		    			if(user_event == 'new_video'){
		    				player.loadVideoById(message_json.new_vid_id);
		    				get_related(message_json.new_vid_id);
				          	
				          	//player.pauseVideo();
				          	player.playVideo();
				          	player.seekTo(0);
				          	var title_timeout =  setInterval(function(){
				          		console.log("title: "+player.getVideoData().title);
				          		if(player.getPlayerState() != -1){
				          			$("#youtube_title").text(player.getVideoData().title);
				          			clearInterval(title_timeout);
				          			player.playVideo();
				          		}
				          		else{
				          			player.seekTo(0);
				          			player.playVideo();
				          		}
				          	}, 1000);

		    			}	
		    			partner_previous_state = user_event;
		    		}
		    		updatePartnerStatus();
		    		console.log('Received ' + data);
	    		});	
	   		});
	   		conn.on('close', function(){
	   			console.log("Disconnected");
	    		change_status_button("user_button", "red");
	   			if(call){
	   				call.close();
	   			}
	   			$("#connect").show();
	    		$("#disconnect_div").hide();
	   		});
	    }
	    

	    function updateMyStatus(){
	    	$("#stat_my_id").text(stat_my_id);
	    	$("#stat_my_mic").text(stat_my_mic);
	    	$("#stat_my_video").text(stat_my_video);
	    	$("#stat_my_size").text(stat_my_size);
	    }

	    function updatePartnerStatus(){
	    	$("#stat_partner_id").text(stat_partner_id);
	    	$("#stat_partner_mic").text(stat_partner_mic);
	    	$("#stat_partner_video").text(stat_partner_video);
	    	$("#stat_partner_size").text(stat_partner_size);
	    }

	    function sendStatus(){
	    	//if(conn != null && conn.open == true){
	    		my_send('{"stat_mic":"'+stat_my_mic+'","stat_video":"'+stat_my_video+'","stat_size":"'+stat_my_size+'"}');
	    	//}
	    }

	    function takeTour(){
	    	var tourSubmitFunc = function(e,v,m,f){
			if(v === -1){
				$.prompt.prevState();
				return false;
			}
			else if(v === 1){
				$.prompt.nextState();
				return false;
			}
			},
			tourStates = [
				{
					title: 'Welcome to Simulchat!',
					html: 'Simulchat allows you to watch videos with someone over the internet. Both people must have their own copy video to play, preferably the same video. The video is NOT streamed.',
					buttons: { Next: 1 },
					focus: 0,
					position: { container: '#take_tour', x: -200, y: 0, width: 400, arrow: '' },
					submit: tourSubmitFunc
				},
				{
					title: 'Your ID',
					html: 'This is your ID for this session. Give it to your partner and they can connect to you!',
					buttons: { Next: 1 },
					focus: 0,
					position: { container: '#my_id', x: 200, y: -10, width: 400, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: 'Their ID',
					html: 'If you have your partner\'s ID, enter it here and click Connect',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#connect_id', x: 200, y: -10, width: 400, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				{
					title: 'Voice Call',
					html: 'When you are connected to your partner, you can enable a voice call so that you can speak while watching the movie together. It works best if you use earphones so that the sound of the movie does not interfere.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#voice_call', x: 10, y: 30, width: 300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Video Call',
					html: 'You can also video call your partner',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#video_call', x: 10, y: 30, width: 300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: "Open a video",
					html: 'Click here to open a video file from your computer. Your partner must also open a video on their side. The video is NOT streamed.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#video_file', x: 30, y: 25, width: 400, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Watch Together',
					html: 'If you are connected to your partner and you both have a movie file selected, you can watch the movie here together. If you pause, they pause. If you skip, they skip and vice versa.',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#my_video', x: 100, y: 120, width:300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Watch YouTube',
					html: 'You can also watch YouTube in sync',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#player', x: 100, y: 120, width:300, arrow: 'tl' },
					submit: tourSubmitFunc
				},
				{
					title: 'Search for a new video',
					html: 'Search for a video and load it for you and your partner',
					buttons: { Prev: -1, Next: 1 },
					focus: 1,
					position: { container: '#search_value', x: 40, y: 0, width:300, arrow: 'lt' },
					submit: tourSubmitFunc
				},
				// {
				// 	title: 'IRC Chat [optional]',
				// 	html: 'This is a web IRC client that connects to a channel called ##simulchat. Here you can find your partner if they are online and send them your ID. It is advised to send a private message, since anyone can see what you time in the defualt channel. Just pick a Nickname and click start. Note that you do not need to use this chat box. It is just there to help you exchange your ID\'s. You can also send your ID to your partner in any way you please, like email',
				// 	buttons: { Prev: -1, Next: 1 },
				// 	focus: 1,
				// 	position: { container: '#kiwi_irc_frame', x: 200, y: 120, width: 400, arrow: 'tm' },
				// 	submit: tourSubmitFunc
				// },
				{
				title: 'Done',
				html: 'Thank you for finishing the tour. This site was made so that people can connect to each other in an easy way. It is still under construction, so watch this space',
				buttons: { Done: 2 },
				focus: 0,
				position: { container: '#my_id', x: -150, y: 20, width: 300, arrow: '' },
				submit: tourSubmitFunc
			}
			];
			$.prompt(tourStates);	
	    }
		(function localFileVideoPlayerInit(win) {
	    var URL = win.URL || win.webkitURL,
	        displayMessage = (function displayMessageInit() {
	            var node = document.querySelector('#message');

	            return function displayMessage(message, isError) {
	                node.innerHTML = message;
	                node.className = isError ? 'error' : 'info';
	            };
	        }()),
	        playSelectedFile = function playSelectedFileInit(event) {
	            file = this.files[0];

	            var type = file.type;

	            videoNode = document.querySelector('#my_video');

	            var canPlay = videoNode.canPlayType(type);

	            canPlay = (canPlay === '' ? 'no' : canPlay);

	            var message = 'Can play type "' + type + '": ' + canPlay;

	            var isError = canPlay === 'no';

	            //displayMessage(message, isError);

	            if (isError) {
	                return;
	            }

	            var fileURL = URL.createObjectURL(file);

	            videoNode.src = fileURL;
	            console.log(videoNode.readyState);
	            console.log(file.name);
	            console.log(file.size);

	            //$("#stat_my_video").text(file.name);
	            //$("#stat_my_size").text(file.size);
	            stat_my_video = insert_spaces(file.name,8);
	            stat_my_size = file.size;
	            sendStatus();
	            updateMyStatus();
				videoNode.onpause = function() {
				   	console.log("Paused " + videoNode.currentTime);
	            	my_send('{"action_change":"paused", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');

				};
				videoNode.onseeked = function() {
				    console.log("Seeked " + videoNode.currentTime);
				    if(Math.abs(videoNode.currentTime - last_received_time) > 1){ //do this so that a infinite loop does not happen (hopefully)
				   		my_send('{"action_change":"seek", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
					}
				};
				videoNode.onplaying = function() {
				    console.log("Playing " + videoNode.currentTime);
				    //my_send('{"action":"status", "time":"'+videoNode.currentTime+'"}');
				    my_send('{"action_change":"play", "time_of_movie":"'+videoNode.currentTime+'", "status":"'+videoNode.readyState+'"}');
				};
	        },
	        inputNode = document.querySelector('#video_file');
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
	    inputNode.addEventListener('change', playSelectedFile, false);
	}(window));
	//YOUTUBE CODE
		var my_timer;
     
      	function load_video_by_id(vid_id){
      	  	player.loadVideoById(vid_id);
          	player.seekTo(0);

          	var title_timeout =  setInterval(function(){
          		console.log("title: "+player.getVideoData().title);
          		if(player.getPlayerState() != -1){
          			$("#youtube_title").text(player.getVideoData().title);
          			clearInterval(title_timeout);
          			player.playVideo();
          		}
          		else{
          			player.seekTo(0);
          			player.playVideo();
          		}
          	}, 1000);
          	get_related(vid_id);
          	my_send('{"user_action":"youtube", "user_event": "new_video", "new_vid_id": "'+vid_id+'"}');
      	}
      	function getQueryVariable(url_string, variable)
      	{
            if(url_string == ''){
              	return(false);
            }
            var query = url_string.split("?");
            var vars = query[1].split("&");
            for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
            }
            //search(url_string);
            return(false);
      	}
      	var tag = document.createElement('script');
      	tag.src = "https://www.youtube.com/iframe_api?autohide=1";
      	var firstScriptTag = document.getElementsByTagName('script')[0];
      	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      	function onYouTubeIframeAPIReady() {
        	player = new YT.Player('player', {
          		height: '390',
          		width: '640',
          		playerVars: { 'autoplay': 0, 'rel':0},
          		videoId: 'n5scparvQWE',
          		events: {
            		'onReady': onPlayerReady,
            		'onStateChange': onPlayerStateChange
         		}
        	});
      	}
      	// 4. The API will call this function when the video player is ready.
      	function onPlayerReady(event) {
        	//event.target.playVideo();
        	console.log("video ready");
     	}
	    // 5. The API calls this function when the player's state changes.
	    //    The function indicates that when playing a video (state=1),
	    //    the player should play for six seconds and then stop.
	    var done = false;
	    function onPlayerStateChange(event) {  
	       	my_send('{"user_action":"youtube", "user_event": "'+event.data+'", "youtube_time": "'+player.getCurrentTime()+'"}');
	       	if(event.data == YT.PlayerState.BUFFERING && previous_state == YT.PlayerState.PLAYING){
       		 	restart_after_buffer = setTimeout(function(){ player.playVideo();
       		 		console.log("restarted");
       		 	}, 2000);
	       	}
	       	if(event.data == YT.PlayerState.PAUSED && previous_state == YT.PlayerState.BUFFERING){	
       			clearTimeout(restart_after_buffer);
       		}
	       	previous_state = event.data;
        	console.log(event.data);
      	}
      	function stopVideo() {
        	player.stopVideo();
      	}
     //});
	//END OF YOUTUBE CODE
	//start of youtube search
		var my_response;

		function showResponse(response) {
		    my_response = response;
		}

		function onClientLoad() {
		    gapi.client.load('youtube', 'v3', onYouTubeApiLoad);
		}

		function onYouTubeApiLoad() {
		    gapi.client.setApiKey('AIzaSyCR5In4DZaTP6IEZQ0r1JceuvluJRzQNLE');
		    search('');
		}

		function search(search_query) {
		    // Use the JavaScript client library to create a search.list() API call.
		    //var search_query = $("#query").val();
		    var request = gapi.client.youtube.search.list({
		        part: 'snippet',
		        q: search_query,
		        //relatedToVideoId: '09R8_2nJtjg',
		        //type: 'video'
		        maxResults: 25
		    });
		    request.execute(onSearchResponse);
		}
		function get_related(video_id){
			$("#related_videos").empty();
			var request = gapi.client.youtube.search.list({
		        part: 'snippet',
		        relatedToVideoId: video_id,
		        maxResults: 25,
		        type: 'video'
		    });
		    request.execute(onRelatedResponse);
		}
		function strip(html){
		   var tmp = document.createElement("DIV");
		   tmp.innerHTML = html;
		   return tmp.textContent || tmp.innerText || "";
		}
		function connect_click(){
	    	console.log($("#connect_id").val());
	    	conn = peer.connect($("#connect_id").val().trim());
	    	my_connect(conn);
	    }
	    /////////////////////////////////////////////////
	    // DOCUMENT READY	
	    /////////////////////////////////////////////////
		$(document).ready(function(){
			ion.sound({
			    sounds: [
			        {
			            name: "message_drop"
			        }
			    ],
			    volume: 0.6,
			    path: "sounds/",
			    preload: true
			});

			$("#voice").hide();
			$("#disconnect_div").hide();
			$("#end_voice_call").hide();
			$("#hang_up").hide();
			$("#end_video_call").hide();
			$("#hang_up_video").hide();
			var video_width = $("#video_div").width();
			var video_height = Math.round(video_width * 9 / 16);
			//var previous_partner_seektime = 0;
			$("#my_video").width(video_width);
			$("#my_video").height(video_height);
			$("#the_player").hover(function(){
	       		// $("#the_player").css("background-color", "yellow");
	       		//console.log("inside");
	        	time = player.getCurrentTime();
	         	my_timer = setInterval(function () {
	            	var cur_time = player.getCurrentTime();
					if (Math.abs(time-cur_time) > 1) {
		                console.log("seeked from "+ time + " to " + cur_time);
		                my_send('{"user_action":"youtube", "user_event": "seeked", "youtube_time": "'+player.getCurrentTime()+'"}');
	            	}
	           		time = cur_time;
	        	}, 100);
	        },function(){
	        // $("#the_player").css("background-color", "pink");
		        //console.log("outside");
		        clearInterval(my_timer);
	   		});
			$("#load_vid").click(function(e){
		      	e.preventDefault();
		        var vid_id = getQueryVariable($("#youtube_link").val(), 'v');
		        if(vid_id){
		          	$("#youtube_link").val('');
		          	load_video_by_id(vid_id);
		        }
		        console.log(vid_id);
	      	});
	      	$("#server_button").click(function(e){
	      		e.preventDefault();
	      		if(peer.open == false){
	      			peer.reconnect();
	      		}
	      	});
			$("#floating_video").hide();

			$("#connect").click(function(e){
		    	e.preventDefault();
		    	connect_click();
		    });
		    
		    $("#disconnect").click(function(e){
		    	e.preventDefault();
		    	conn.close();
		    });
		    $("#voice_call").click(function(e){
		    	e.preventDefault();
		    	if(call != null){
		    		call.close();
		    	}
		    	if(window.localStream != null && window.localStream.getAudioTracks().length > 0)
		    	{
		    		$("#voice_call").hide();
		    		$("#hang_up").show();
		    		if(window.localStream.getVideoTracks().length > 0){
		    			window.localStream.getVideoTracks()[0].enabled = false;
		    		}
			    	call = peer.call(conn.peer, window.localStream, {metadata:'voice'});
			    	call.on('stream', function(stream){
			    		window.remoteStream = stream;
				      	change_status_button("call_button","green");
			    		$("#hang_up").hide();
				        $('audio').prop('src', URL.createObjectURL(stream));
				        $("#end_voice_call").show();
				        $("#voice_call").hide();
				    });
				    call.on('close', function(){
				      	change_status_button("call_button","red");
				  	  	$("#end_voice_call").hide();
					    $("#voice_call").show();
					    $("#hang_up").hide();
			  	 	});
				}
				else{
					get_mic();
					$.prompt("Your browser is asking you to activate your microphone. The popup should be somewhere on the top or bottom of your screen", {
						title: "Activate Your Microphone and try again.",
						buttons: { "OK": true}
					});
				}
		    });
			$("#video_call").click(function(e){
		    	e.preventDefault();
		    	if(call != null){
		    		call.close();
		    	}
		    	if(window.localStream != null && window.localStream.getVideoTracks().length > 0)
		    	{
		    		$("#video_call").hide();
		    		$("#hang_up_video").show();
		    		if(window.localStream.getVideoTracks().length > 0){
		    			window.localStream.getVideoTracks()[0].enabled = true;
		    		}
			    	call = peer.call(conn.peer, window.localStream, {metadata:'video'});
			    	call.on('stream', function(stream){
			    		window.remoteStream = stream;
				      	change_status_button("video_call_button","green");
			    		$("#hang_up_video").hide();
				        $('#their-video').prop('src', URL.createObjectURL(stream));
				        $('#their-video-smaller').prop('src', URL.createObjectURL(stream));
				        $("#end_video_call").show();
				        //$("#voice_call").hide();
				    });
				    call.on('close', function(){
				      	change_status_button("video_call_button","red");
				  	  	$("#end_video_call").hide();
					    $("#video_call").show();
					    $("#hang_up_video").hide();
			  	 	});
				}
				else{
					get_cam();
					$.prompt("Your browser is asking you to activate your camera. The popup should be somewhere on the top or bottom of your screen", {
						title: "Activate Your Camera and try again.",
						buttons: { "OK": true}
					});
				}
		    });
		    $("#hang_up").click(function(e){
		    	e.preventDefault();
		    	$("#hang_up").hide();
		    	$("#voice_call").show();
		    	my_send('{"call_status": "hang_up"}');
		    });
		    $("#hang_up_video").click(function(e){
		    	e.preventDefault();
		    	$("#hang_up_video").hide();
		    	$("#video_call").show();
		    	my_send('{"call_status": "hang_up_video"}');
		    });
		    $("#end_voice_call").click(function(e){
		    	e.preventDefault();
		    	if(call){
		    		call.close();
		    	}
		    	my_send('{"call_status": "hang_up"}');
		    });
		    $("#end_video_call").click(function(e){
		    	e.preventDefault();
		    	if(call){
		    		call.close();
		    	}
		    	my_send('{"call_status": "hang_up_video"}');
		    });
		    $("#take_tour").click(function(e){
		    	e.preventDefault();
		    	ga('send', 'event', 'Clicks', 'Tour');
		    	takeTour();
		    });
			$("#call_section").hover(function(){
				$("#floating_video").hide();
			},function(){
				if(call != null && call.open == true){
					$("#floating_video").show();
				}
			});
			$(".header").click(function (e) {
				//get CSS display state of .toggle_chat element
				var toggleState = $('.toggle_chat').css('display');
				
				//toggle show/hide chat box
				$('.toggle_chat').slideToggle();
				
				//use toggleState var to change close/open icon image
				if(toggleState == 'block')
				{
					$(".header div").attr('class', 'open_btn');

				}else{
					$(".header div").attr('class', 'close_btn');
					$("#shout_message").focus();
				}
				var scrolltoh = $('.message_box')[0].scrollHeight;
				$('.message_box').scrollTop(scrolltoh);
				update_badge();
			});
			$("#shout_message").keypress(function(evt) {
				if(evt.which == 13) {
					var iusername = $('#shout_username').val();
					var imessage = strip($('#shout_message').val());
					
					var to_send = {textMessage:"true", name:encodeURIComponent(iusername), message:encodeURIComponent(imessage)};
					console.log(to_send);
					var to_send = JSON.stringify(to_send);
					console.log(to_send);
					$('.alert_shout_msg').remove();
					var d= new Date();
					var msg_time = d.toLocaleTimeString();
					if(conn != null && conn.open == true){
						if(imessage.length > 0){
							my_send(to_send);
							//imessage = imessage.replace(regex, "<a href='$1' target='_blank'>$1</a>");
							var data;
							if(previous_sender != "me"){
							 data = '<div class="shout_msg me_shout_msg"><time>'+msg_time+'</time><span class="username my_username">You</span><span class="message">'+imessage+'</span></div>';
							 	previous_sender = "me";
							}
							else{
								data = '<div class="shout_msg me_shout_msg"><time>'+msg_time+'</time><span class="message">'+imessage+'</span></div>';
							}
							//append data into messagebox with jQuery fade effect!
							$(data).linkify().hide().appendTo('.message_box').fadeIn();
			
							//keep scrolled to bottom of chat!
							var scrolltoh = $('.message_box')[0].scrollHeight;
							$('.message_box').scrollTop(scrolltoh);
							
							//reset value of message box
							$('#shout_message').val('');
						}
					}
					else{
						//$('.alert_shout_msg').remove();
						var data = '<div class="shout_msg alert_shout_msg"><time>'+msg_time+'</time><span class="username alert_msg">Alert</span><span class="message alert_msg">You are not connected</span></div>';
						//append data into messagebox with jQuery fade effect!
						$(data).hide().appendTo('.message_box').fadeIn();
		
						//keep scrolled to bottom of chat!
						var scrolltoh = $('.message_box')[0].scrollHeight;
						$('.message_box').scrollTop(scrolltoh);
					}
				}
			});
			$("#the_results").on('click', '.a_search_result', function(e){
			  	e.preventDefault();
			  	load_video_by_id($(this).attr('video-id'));
			  	my_scroll("#youtube_heading");
			  	console.log("clicked");
			});
			$("#related_videos").on('click', '.a_search_result', function(e){
			  	e.preventDefault();
			  	load_video_by_id($(this).attr('video-id'));
			  	my_scroll("#youtube_heading");
			  	console.log("clicked");
			});
			$('#search_value').keyup(function(e){
			    if(e.keyCode == 13)
			    {
			        $(this).trigger("searchYoutube");
			    }
			});	
			$('#search_value').bind("searchYoutube",function(e){
				$("#the_results").scrollTop(0);
				$('#the_results').empty();
			  	search($("#search_value").val());
			  	my_scroll("#results_heading");
			});
			$('#youtube_link').keyup(function(e){
			    if(e.keyCode == 13)
			    {
			        $(this).trigger("loadURL");
			    }
			});	
			$('#youtube_link').bind("loadURL",function(e){
			  	//search($("#search_value").val());
			  	var vid_id = getQueryVariable($("#youtube_link").val(), 'v');
		        if(vid_id){
		          	$("#youtube_link").val('');
		          	load_video_by_id(vid_id);
		        }
			});
			$('#connect_id').keyup(function(e){
			    if(e.keyCode == 13)
			    {
			        $(this).trigger("clickOnConnect");
			    }
			});	
			$('#connect_id').bind("clickOnConnect",function(e){
			  	connect_click();
			});
		});
		// Called automatically with the response of the YouTube API request.
		function onSearchResponse(response) {
		    //$('#results').empty();
            //$('#the_results').empty();
            var num_of_videos = 0;
            for(var i = 0; i < response.items.length; i++){
              	if(response.items[i].id.kind == "youtube#video"){
                	//console.log(response.items[i].id.videoId + " " + response.items[i].snippet.title + " " + response.items[i].snippet.thumbnails.default.url);
                	$("#the_results").append('<div class="row a_search_result" video-id="'+response.items[i].id.videoId+'"><a href="#"><div class="col-md-3"><img src="'+response.items[i].snippet.thumbnails.default.url+'"></div><div class="col-md-9"><h4>'+ response.items[i].snippet.title +'</h4><p>'+response.items[i].snippet.channelTitle+'</p></div></a></div>');
                	num_of_videos = num_of_videos+1;
             	}
             	// if(num_of_videos == 5){
             	// 	break;
             	// }
            }
		}
		function onRelatedResponse(response) {
		    //$('#results').empty();
            //$('#the_results').empty();
            var num_of_videos = 0;
            for(var i = 0; i < response.items.length; i++){
              	if(response.items[i].id.kind == "youtube#video"){
                	//console.log(response.items[i].id.videoId + " " + response.items[i].snippet.title + " " + response.items[i].snippet.thumbnails.default.url);
                	$("#related_videos").append('<div class="container-fluid"><div class="row a_search_result" video-id="'+response.items[i].id.videoId+'"><a href="#"><div class="col-md-6"><img src="'+response.items[i].snippet.thumbnails.default.url+'"></div><div class="col-md-6"><h6>'+ response.items[i].snippet.title +'</h6><p>'+response.items[i].snippet.channelTitle+'</p></div></a></div></div>');
                	num_of_videos = num_of_videos+1;
             	}
             	if(num_of_videos == 17){
             		break;
             	}
            }
		}
	//end of youtube search
</script>
 <script src="https://apis.google.com/js/client.js?onload=onClientLoad" type="text/javascript"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60494371-1', 'auto');
  ga('send', 'pageview');
</script>

<script src="//vjs.zencdn.net/4.12/video.js"></script>
